<app-page>
  <div class="blogs" page-body>
    <div class="blogs-shell">
      <!-- LEFT: Mobile preview -->
      <aside class="panel panel--left" aria-label="Mobile preview">
        <div class="phone-frame iphone-frame">
          <div class="phone-screen">
          @if (selectedPost) {
            <div class="m-article">
              <div class="m-status-row">
                <span class="m-time">9:41</span>
                <div class="dynamic-island" aria-hidden="true"></div>
                <span class="m-status-icons">
                  <app-icon [fontIcon]="'signal_cellular_alt'" [size]="12"></app-icon>
                  <app-icon [fontIcon]="'wifi'" [size]="12"></app-icon>
                  <span class="m-battery">100%</span>
                  <app-icon [fontIcon]="'battery_full'" [size]="14"></app-icon>
                </span>
              </div>
              <div class="m-appbar">
                <button type="button" class="m-icon" aria-label="Back">
                  <app-icon [fontIcon]="'arrow_back'" [size]="22"></app-icon>
                </button>
                <div class="m-title">Article Details</div>
                <button type="button" class="m-icon" aria-label="Share">
                  <app-icon [fontIcon]="'share'" [size]="22"></app-icon>
                </button>
              </div>
              <div class="m-body">
                <div class="m-sheet">
                  <div class="m-author-card">
                    <div class="m-avatar">
                      <app-icon [fontIcon]="'person'" [size]="24"></app-icon>
                    </div>
                    <div class="m-author-meta">
                      <div class="m-author-name">{{ selectedPost.authorName }}</div>
                      <div class="m-author-sub">{{ selectedPost.category }}</div>
                      <div class="m-author-date">{{ formatDateShort(selectedPost.updatedAt) }}</div>
                    </div>
                    <div class="m-pill">{{ selectedPost.readTimeMin }} min read</div>
                  </div>
                  <div class="m-cover-card">
                    @if (selectedPost.coverImageUrl) {
                      <img class="m-cover-img" [src]="selectedPost.coverImageUrl" alt="">
                    } @else {
                      <div class="m-cover-placeholder">
                        <app-icon [fontIcon]="'image'" [size]="32"></app-icon>
                      </div>
                    }
                  </div>
                  <h1 class="m-h1">{{ selectedPost.title }}</h1>
                  <div class="m-content" [class.m-content--collapsed]="!isContentExpanded && (selectedPost.content || '').length > 320">
                    <div [innerHTML]="getSafeContent()"></div>
                    @if ((selectedPost.content || '').length > 320) {
                      <button type="button" class="m-more" (click)="toggleContentExpanded()">
                        {{ isContentExpanded ? 'Show Less' : 'Show more' }}
                      </button>
                    }
                  </div>
                  <div class="m-actions">
                    <div class="m-act-item">
                      <app-icon [fontIcon]="'favorite_border'" [size]="22"></app-icon>
                      <span class="m-act-label">{{ selectedPost.likes }}</span>
                    </div>
                    <div class="m-act-item">
                      <app-icon [fontIcon]="'chat_bubble_outline'" [size]="22"></app-icon>
                      <span class="m-act-label">0</span>
                    </div>
                    <div class="m-act-item">
                      <app-icon [fontIcon]="'share'" [size]="22"></app-icon>
                      <span class="m-act-label">Share</span>
                    </div>
                    <div class="m-act-item">
                      <app-icon [fontIcon]="'bookmark_border'" [size]="22"></app-icon>
                      <span class="m-act-label">Save</span>
                    </div>
                  </div>
                  @if (selectedPost.documents.length > 0) {
                    <div class="m-related">
                      <div class="m-related-title">Related Documents</div>
                      @for (d of selectedPost.documents; track d.id) {
                        <a class="m-doc" [href]="d.url" target="_blank" rel="noreferrer">
                          <div class="m-doc-left">
                            <div class="m-doc-ic" [class.m-doc-ic--pdf]="d.type === 'PDF'">
                              <app-icon [fontIcon]="getDocIcon(d.type)" [size]="20"></app-icon>
                            </div>
                            <div>
                              <div class="m-doc-name">{{ d.title }}</div>
                              <div class="m-doc-sub">Tap to view PDF</div>
                            </div>
                          </div>
                          <app-icon [fontIcon]="'chevron_right'" [size]="22"></app-icon>
                        </a>
                      }
                    </div>
                  }
                  @if (selectedPost.tags.length > 0) {
                    <div class="m-tags">
                      <div class="m-related-title">Tags</div>
                      <div class="m-tag-pills">
                        @for (t of selectedPost.tags; track t) {
                          <span class="m-tag-pill">{{ t }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          } @else {
            <div class="mobile-preview-empty">
              <app-icon [fontIcon]="'phone_iphone'" [size]="32"></app-icon>
              <p>iPhone preview</p>
              <span>Select or create a post to see how it looks on device.</span>
            </div>
          }
          </div>
        </div>
      </aside>

      <!-- CENTER: Editor -->
      <section class="panel panel--center" aria-label="Blog editor">
        <div class="topbar">
          <div class="crumbs">
            <span class="crumb-muted">Drafts</span>
            <span class="crumb-sep">/</span>
            <span class="crumb-strong">{{ (selectedPost?.title || 'New Article') }}</span>
          </div>
          <div class="topbar-actions">
            @if (selectedPost) {
              <app-button text="Save draft" appearance="flat" (btnClick)="saveDraft()"></app-button>
              <app-button text="Publish" color="primary" appearance="raised" (btnClick)="publish()"></app-button>
            }
            <app-button appearance="icon" [fontIcon]="'add'" title="New post" (btnClick)="createNewPost()"></app-button>
          </div>
        </div>

        <div class="editor">
          @if (!selectedPost) {
            <div class="editor-empty" aria-live="polite">
              <div class="editor-empty-icon" aria-hidden="true">
                <app-icon [fontIcon]="'edit_note'" [size]="48"></app-icon>
              </div>
              <h2 class="editor-empty-title">No post selected</h2>
              <p class="editor-empty-desc">Create a new post or select one from the list to start editing.</p>
              <app-button text="New post" color="primary" appearance="raised" (btnClick)="createNewPost()"></app-button>
            </div>
          } @else {
            <article class="editor-sheet">
              <header class="editor-header">
                <input
                  class="editor-title"
                  [(ngModel)]="selectedPost.title"
                  placeholder="Article title"
                  type="text"
                  aria-label="Article title" />
                <div class="editor-meta">
                  <div class="editor-meta-field">
                    <label class="editor-label" for="edit-status">Status</label>
                    <select id="edit-status" class="editor-select" [(ngModel)]="selectedPost.status">
                      <option value="DRAFT">Draft</option>
                      <option value="PUBLISHED">Published</option>
                      <option value="SCHEDULED">Scheduled</option>
                    </select>
                  </div>
                  <div class="editor-meta-field">
                    <label class="editor-label" for="edit-category">Category</label>
                    <select id="edit-category" class="editor-select" [(ngModel)]="selectedPost.category">
                      @for (c of categories; track c) {
                        <option [value]="c">{{ c }}</option>
                      }
                    </select>
                  </div>
                  <div class="editor-meta-field">
                    <label class="editor-label" for="edit-visibility">Visibility</label>
                    <select id="edit-visibility" class="editor-select" [(ngModel)]="selectedPost.visibility">
                      <option value="PUBLIC">Public</option>
                      <option value="PRIVATE">Private</option>
                    </select>
                  </div>
                  @if (selectedPost.status === 'SCHEDULED') {
                    <div class="editor-meta-field editor-meta-field--schedule">
                      <label class="editor-label" for="edit-schedule">Schedule</label>
                      <input id="edit-schedule" class="editor-input" type="datetime-local" [(ngModel)]="selectedPost.scheduledFor" />
                    </div>
                  }
                  <div class="editor-meta-field editor-meta-field--cover">
                    <span class="editor-label" id="edit-cover-label">Cover</span>
                    <input class="editor-file-input" type="file" accept="image/*" (change)="onCoverSelected($event)" #coverFile aria-labelledby="edit-cover-label" />
                    <button type="button" class="editor-action-btn" (click)="coverFile.click()" aria-labelledby="edit-cover-label">
                      @if (selectedPost.coverImageUrl) {
                        <app-icon [fontIcon]="'image'" [size]="16"></app-icon>
                        <span>Change</span>
                      } @else {
                        <app-icon [fontIcon]="'add_a_photo'" [size]="16"></app-icon>
                        <span>Add cover</span>
                      }
                    </button>
                  </div>
                  <div class="editor-meta-field editor-meta-field--attach">
                    <span class="editor-label" id="edit-attach-label">Attachments</span>
                    <input #docInput class="editor-file-input" type="file" multiple accept=".pdf,.doc,.docx,application/pdf" (change)="onDocSelected($event)" aria-labelledby="edit-attach-label" />
                    <button type="button" class="editor-action-btn" (click)="docInput.click()" aria-labelledby="edit-attach-label">
                      <app-icon [fontIcon]="'attach_file'" [size]="16"></app-icon>
                      <span>Add files</span>
                    </button>
                    @if (selectedPost.documents.length > 0) {
                      <ul class="editor-docs">
                        @for (d of selectedPost.documents; track d.id) {
                          <li class="editor-doc">
                            <app-icon [fontIcon]="getDocIcon(d.type)" [size]="14"></app-icon>
                            <span class="editor-doc-name">{{ d.title }}</span>
                            <button type="button" class="editor-doc-remove" (click)="removeDoc(d.id); $event.stopPropagation()" aria-label="Remove attachment">×</button>
                          </li>
                        }
                      </ul>
                    }
                  </div>
                </div>
                <div class="editor-tags">
                  <label class="editor-label" for="edit-tag-input">Tags</label>
                  <div class="editor-tags-row">
                    <div class="editor-tags-chips">
                      @for (t of selectedPost.tags; track t) {
                        <span class="editor-tag">
                          {{ t }}
                          <button type="button" class="editor-tag-remove" (click)="removeTag(t)" aria-label="Remove tag {{ t }}">×</button>
                        </span>
                      }
                    </div>
                    <input
                      id="edit-tag-input"
                      class="editor-input editor-tag-input"
                      placeholder="Add tag, press Enter"
                      [(ngModel)]="tagInput"
                      (keydown.enter)="$event.preventDefault(); addTagFromInput()"
                      aria-label="Add tag" />
                  </div>
                </div>
              </header>
              <section class="editor-content" aria-label="Article content">
                <div class="editor-content-toolbar">
                  <button type="button" class="editor-toolbar-btn" title="Bold" (mousedown)="$event.preventDefault(); formatBold()" aria-label="Bold">
                    <app-icon [fontIcon]="'format_bold'" [size]="18"></app-icon>
                  </button>
                  <button type="button" class="editor-toolbar-btn" title="Italic" (mousedown)="$event.preventDefault(); formatItalic()" aria-label="Italic">
                    <app-icon [fontIcon]="'format_italic'" [size]="18"></app-icon>
                  </button>
                  <span class="editor-toolbar-sep" aria-hidden="true"></span>
                  <button type="button" class="editor-toolbar-btn" title="Bullet list" (mousedown)="$event.preventDefault(); formatBulletList()" aria-label="Bullet list">
                    <app-icon [fontIcon]="'format_list_bulleted'" [size]="18"></app-icon>
                  </button>
                  <button type="button" class="editor-toolbar-btn" title="Numbered list" (mousedown)="$event.preventDefault(); formatNumberedList()" aria-label="Numbered list">
                    <app-icon [fontIcon]="'format_list_numbered'" [size]="18"></app-icon>
                  </button>
                </div>
                <div
                  #contentInput
                  class="editor-body content-input-editable"
                  contenteditable="true"
                  role="textbox"
                  aria-multiline="true"
                  (input)="onContentInput()"
                  data-placeholder="Write your article here. Use the toolbar for bold, italic, and lists."></div>
              </section>
            </article>
          }
        </div>
      </section>
    </div>
  </div>
</app-page>