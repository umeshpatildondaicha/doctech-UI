<div class="timing-dialog" [class.view-mode]="isViewMode">
  <!-- Dialog Content -->
  <div class="dialog-content">
    <form [formGroup]="timingForm" (ngSubmit)="onSubmit()" class="form">

      <!-- Time For Section -->
      <div class="form-row">
        <mat-form-field>
          <mat-label>Time For</mat-label>
          <mat-select
            formControlName="timeFor"
            placeholder="Select time frequency"
            [required]="true">
            @for (option of timeForOptions; track option) {
              <mat-option [value]="option.value">
                {{ option.label }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (timingData.timeFor !== 'leave') {
          <!-- Working Hours Section -->
          <div class="working-hours-section">
            <div class="section-header">
              <h4 class="section-title">Working Hours:</h4>
              <span class="time-range">{{ getAppointmentTimeRange() }}</span>
            </div>
            <div class="time-inputs">
              <div class="time-row">
                <app-input
                  label="Start Time"
                  formControlName="startTime"
                  type="time"
                  placeholder="Start time"
                  [required]="true">
                </app-input>
                <span class="time-separator">-</span>
                <app-input
                  label="End Time"
                  formControlName="endTime"
                  type="time"
                  placeholder="End time"
                  [required]="true">
                </app-input>
              </div>
              <!-- Working Hours Validation Error -->
              @if (getWorkingHoursValidationError()) {
                <div class="validation-error">
                  <span class="error-message">{{ getWorkingHoursValidationError() }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Scheduling Type Section -->
      @if (timingData.timeFor !== 'leave') {
        <div class="form-row">
          <mat-form-field>
            <mat-label>Scheduling Type</mat-label>
            <mat-select
              formControlName="schedulingType"
              placeholder="Select scheduling type"
              [required]="true">
              @for (option of schedulingTypeOptions; track option) {
                <mat-option [value]="option.value">
                  {{ option.label }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      }

      <!-- Scheduling Type Description -->
      @if (timingData.timeFor !== 'leave') {
        <div class="scheduling-type-info">
          <div class="info-card">
            <app-icon [fontIcon]="timingData.schedulingType === 'slots' ? 'schedule' : 'access_time'" class="info-icon"></app-icon>
            <div class="info-content">
              <h4>{{ getSchedulingTypeLabel() }}</h4>
              <p>{{ getSchedulingTypeDescription() }}</p>
            </div>
          </div>
        </div>
      }

      <!-- Leave Form Section -->
      @if (timingData.timeFor === 'leave') {
        <div class="leave-form-section">
          <div class="form-row">
            <app-date-picker
              label="Select Date"
              formControlName="selectedDate"
              placeholder="Select date"
              [required]="true">
            </app-date-picker>
          </div>
          <div class="form-row">
            <app-input
              class="leave-reason-input"
              label="Reason"
              formControlName="reason"
              placeholder="Enter reason for leave"
              [required]="true"
              [multiline]="true"
              [rows]="3">
            </app-input>
          </div>
        </div>
      }

      <!-- Regular Timing Form Section -->
      @if (timingData.timeFor === 'daily' || timingData.timeFor === 'weekly' || timingData.timeFor === 'specific_day') {
        <div class="regular-timing-section">
          <!-- Scheduling Type Specific Fields -->
          <div class="scheduling-fields">
            <div class="form-row field-gapping">
              <!-- Slot-based scheduling fields -->
              @if (timingData.schedulingType === 'slots') {
                <app-input
                  label="Slot Duration (Minutes)"
                  formControlName="slotDuration"
                  type="number"
                  placeholder="Duration per slot"
                  [required]="true">
                </app-input>
              }
              <!-- Flexible scheduling field -->
              @if (timingData.schedulingType === 'flexible') {
                <app-input
                  label="Max Appointments Per Day"
                  formControlName="maxAppointmentsPerDay"
                  type="number"
                  placeholder="Maximum appointments per day"
                  [required]="true">
                </app-input>
              }
              <!-- Max Appointments per Slot (only for slot-based) -->
              @if (timingData.schedulingType === 'slots') {
                <app-input
                  label="Max Appointments /Slot"
                  formControlName="maxAppointmentsPerSlot"
                  type="number"
                  placeholder="Max appointments per slot"
                  [required]="true">
                </app-input>
              }
            </div>
            <!-- Available Slots Display (only for slot-based) -->
            @if (timingData.schedulingType === 'slots' && calculateAvailableSlots() > 0) {
              <div class="slots-info">
                <div class="info-badge">
                  <app-icon [fontIcon]="'event_available'" class="badge-icon"></app-icon>
                  <span>{{ calculateAvailableSlots() }} available slots</span>
                </div>
                <div class="calculation-info">
                  <span class="calculation-text">
                    Total appointments: {{ calculateTotalAppointments() }}
                    ({{ calculateAvailableSlots() }} slots Ã— {{ timingData.maxAppointmentsPerSlot || 1 }} per slot)
                  </span>
                </div>
              </div>
            }
            <!-- Flexible Scheduling Info (only for flexible) -->
            @if (timingData.schedulingType === 'flexible') {
              <div class="flexible-info">
                <div class="info-badge">
                  <app-icon [fontIcon]="'queue'" class="badge-icon"></app-icon>
                  <span>First come, first served scheduling</span>
                </div>
              </div>
            }
          </div>
          <!-- Day Selection Section -->
          <div class="form-row">
            <!-- Specific Date Section -->
            @if (timingData.timeFor === 'specific_day') {
              <app-date-picker
                label="Select Date"
                formControlName="selectedDate"
                placeholder="Select specific date"
                [required]="true">
              </app-date-picker>
            }
            @if (timingData.timeFor === 'weekly') {
              <div class="day-selection">
                <mat-form-field>
                  <mat-label>Select Day</mat-label>
                  <mat-select
                    formControlName="selectedDays"
                    placeholder="Select days">
                    @for (option of dayOptions; track option) {
                      <mat-option [value]="option.value">
                        {{ option.label }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            }
          </div>
          <!-- Appointment Time Section -->
          <div class="appointment-time-section">
            <div class="section-header">
              <h4 class="section-title">Appointment Time:</h4>
              <span class="time-range">{{ getAppointmentTimeRange() }}</span>
            </div>
            <!-- Breaks Section -->
            <div class="breaks-section">
              <div formArrayName="breaks">
                @for (break of breaks.controls; track break; let i = $index) {
                  <div [formGroupName]="i" class="break-item">
                    <div class="break-row">
                      <app-input
                        label="Reason"
                        formControlName="reason"
                        placeholder="Break reason"
                        [required]="true">
                      </app-input>
                      <div class="break-time">
                        <div class="time-display">
                          <app-input
                            formControlName="startTime"
                            type="time"
                            [label]="'Start Time'"
                            placeholder="Start time"
                            [required]="true">
                          </app-input>
                          <span class="time-separator">-</span>
                          <app-input
                            formControlName="endTime"
                            type="time"
                            [label]="'End Time'"
                            placeholder="End time"
                            [required]="true">
                          </app-input>
                          @if ((breaks.length > 1) && !isViewMode) {
                            <app-icon [fontIcon]="'close'" (iconClick)="removeBreak(i)" class="remove-break-btn" [isCovered]="true"></app-icon>
                          }
                        </div>
                      </div>
                    </div>
                    <!-- Break Validation Errors -->
                    @if (getBreakValidationErrors(i).length > 0) {
                      <div class="validation-error">
                        @for (error of getBreakValidationErrors(i); track error) {
                          <span class="error-message">{{ error }}</span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
              @if (!isViewMode) {
                <app-button type="button" class="add-break-btn" (btnClick)="addBreak()" [text]="'ADD BREAK'" [appearance]="'basic'">
                </app-button>
              }
            </div>
          </div>
          <!-- Advanced Options Section -->
          <div class="advanced-options-section">
            <div class="section-header" (click)="toggleAdvancedOptions()">
              <h4 class="section-title">ADVANCE OPTION</h4>
              <app-icon [fontIcon]="advancedOptionsExpanded ? 'expand_less' : 'expand_more'" class="expand-icon"></app-icon>
            </div>
            @if (advancedOptionsExpanded) {
              <div class="advanced-content">
                <div class="form-row field-gapping">
                  <app-input
                    [label]="'Buffer Time Btn Slots' + ' (Sec)'"
                    formControlName="bufferTime"
                    type="number"
                    placeholder="Buffer time in seconds"
                    [required]="true">
                  </app-input>
                  <mat-form-field>
                    <mat-label>Slot Prioritization</mat-label>
                    <mat-select
                      formControlName="slotPrioritization"
                      placeholder="Select priority"
                      [required]="true">
                      @for (option of priorityOptions; track option) {
                        <mat-option [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            }
          </div>
        </div>
        } <!-- End of regular-timing-section -->
      </form>
    </div>

  </div>