<div class="appointment-create-dialog" [class.view-mode]="isViewMode">

  <!-- Dialog Content -->
  <div class="dialog-content">
    <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="form">

      <div class="section-title-wrapper"><h4 class="section-title">Appointment Details</h4></div>

      <div class="form-row top-space">
        <div class="patient-search-section">
          <label class="form-label" for="patient-search-input">Patient <span class="required">*</span></label>
          <div class="patient-search-input" [class.error-state]="!selectedPatient && appointmentForm.get('patient_id')?.touched">
            <app-input
              id="patient-search-input"
              [value]="getSelectedPatientDisplayName()"
              placeholder="Search and select patient..."
              [disabled]="false"
              (click)="openPatientSearch()"
              (keydown)="onPatientInputKeydown($event)"
              (input)="onPatientInput($event)"
              [required]="true"
              [errorMessage]="getPatientErrorMessage()"
              [suffixIconName]="'search'"
              >
            </app-input>
          </div>

          <!-- Patient Selection Required Message -->
          @if (!selectedPatient) {
            <div class="patient-selection-hint">
              <app-icon [fontIcon]="'info'" [size]="16"></app-icon>
              <span>Click above to open the list, select a patient, then click <strong>Select Patient</strong> in the dialog to add them.</span>
            </div>
          }

          <!-- Patient Details Display -->
          @if (selectedPatient) {
            <div class="patient-details">
              <div class="patient-info-card">
                <div class="patient-header">
                  <div class="patient-avatar">
                    <app-icon [fontIcon]="'person'" [size]="24"></app-icon>
                  </div>
                  <div class="patient-basic-info">
                    <h4 class="patient-name">{{ getSelectedPatientDisplayName() }}</h4>
                    <p class="patient-id">ID: {{ getSelectedPatientDisplayId() }}</p>
                  </div>
                  <app-button
                  class="change-patient-btn"
                  [fontIcon]="'edit'"
                  [text]="'change'"
                  (btnClick)="openPatientSearch()"
                  ></app-button>
                  <!-- <button type="button" class="change-patient-btn" (click)="openPatientSearch()">
                    <app-icon [fontIcon]="'edit'" [size]="16"></app-icon>
                    Change
                  </button> -->
                </div>
                <div class="patient-details-grid">
                  @if (selectedPatient.dateOfBirth) {
                    <div class="detail-item">
                      <span class="detail-label">Age:</span>
                      <span class="detail-value">{{ calculateAge(selectedPatient.dateOfBirth) }} years</span>
                    </div>
                  }
                  @if (selectedPatient.gender) {
                    <div class="detail-item">
                      <span class="detail-label">Gender:</span>
                      <span class="detail-value">{{ selectedPatient.gender }}</span>
                    </div>
                  }
                  @if (selectedPatient.contact) {
                    <div class="detail-item">
                      <span class="detail-label">Contact:</span>
                      <span class="detail-value">{{ selectedPatient.contact }}</span>
                    </div>
                  }
                  @if (selectedPatient.email) {
                    <div class="detail-item">
                      <span class="detail-label">Email:</span>
                      <span class="detail-value">{{ selectedPatient.email }}</span>
                    </div>
                  }
                </div>
                @if (selectedPatient.medicalHistory?.length) {
                  <div class="medical-info">
                    <h5 class="info-title">Medical History</h5>
                    <div class="info-tags">
                      @for (condition of selectedPatient.medicalHistory; track condition) {
                        <span class="info-tag medical-tag">
                          {{ condition }}
                        </span>
                      }
                    </div>
                  </div>
                }
                @if (selectedPatient.allergies?.length) {
                  <div class="medical-info">
                    <h5 class="info-title">Allergies</h5>
                    <div class="info-tags">
                      @for (allergy of selectedPatient.allergies; track allergy) {
                        <span class="info-tag allergy-tag">
                          {{ allergy }}
                        </span>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
      <div class="form-row calendar-container-wrapper">
        <app-calendar
          class="calendar-container"
          [showNavigation]="true"
          [showToday]="true"
          [events]="calendarEvents"
          (dateSelected)="onDateSelected($event)"
          (eventClicked)="onEventClicked($event)">
        </app-calendar>
      </div>
      <div class="form-row">
        <app-input class="notes-input" [rows]="3" [multiline]="true" label="Notes" formControlName="notes" placeholder="Enter appointment notes"></app-input>
      </div>
    </form>
  </div>
</div>