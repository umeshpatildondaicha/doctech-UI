<div class="diet-form-dialog" [class.view-mode]="isViewMode">

  <!-- View Mode Content -->
  @if (isViewMode) {
    <div class="dialog-content">
      <div class="diet-view-container">
        <!-- Large Image Section -->
        <div class="diet-image-section">
          <img [src]="dietForm.get('imageUrl')?.value || imagePreview"
            alt="Diet"
            class="diet-main-image"
            (error)="onImageError($event)">
            <app-button
            class="close-overlay-btn"
            [fontIcon]="'close'"
            [text]="'Close'"
            (btnClick)="onCancel()"
            ></app-button>
          </div>
          <!-- Content Grid -->
          <div class="diet-content-grid">
            <!-- Left Column - Recipe Details -->
            <div class="recipe-details">
              <h1 class="recipe-title">{{ dietForm.get('name')?.value }}</h1>
              <p class="recipe-description">{{ dietForm.get('description')?.value }}</p>
              <!-- Tags -->
              <div class="recipe-tags">
                @if (dietForm.get('dietType')?.value) {
                  <span class="tag-chip">
                    {{ dietForm.get('dietType')?.value }}
                  </span>
                }
                @for (tag of getTagsArray(); track tag) {
                  <span class="tag-chip">{{ tag }}</span>
                }
              </div>
              <!-- Video Section -->
              @if (dietForm.get('videoUrl')?.value) {
                <div class="video-section">
                  <div class="video-header">
                    <mat-icon>video_library</mat-icon>
                    <span>Video</span>
                  </div>
                  <div class="video-placeholder">
                    <mat-icon>broken_image</mat-icon>
                    <span>Video content not available</span>
                  </div>
                </div>
              }
            </div>
            <!-- Right Column - Nutritional Information -->
            <div class="nutritional-section">
              <div class="nutrition-grid-view">
                <div class="nutrition-card">
                  <div class="nutrition-label">Calories</div>
                  <div class="nutrition-value">{{ dietForm.get('calories')?.value }}</div>
                </div>
                <div class="nutrition-card">
                  <div class="nutrition-label">Protein (g)</div>
                  <div class="nutrition-value">{{ dietForm.get('protein')?.value }}</div>
                </div>
                <div class="nutrition-card">
                  <div class="nutrition-label">Carbs (g)</div>
                  <div class="nutrition-value">{{ dietForm.get('carbs')?.value }}</div>
                </div>
                <div class="nutrition-card">
                  <div class="nutrition-label">Fat (g)</div>
                  <div class="nutrition-value">{{ dietForm.get('fat')?.value }}</div>
                </div>
                <div class="nutrition-card">
                  <div class="nutrition-label">Fiber (g)</div>
                  <div class="nutrition-value">{{ dietForm.get('fiber')?.value }}</div>
                </div>
              </div>
              <!-- Action Buttons -->
              <div class="action-buttons">
                <app-button
                class="action-btn edit-btn"
                [fontIcon]="'edit'"
                title="Edit"
                (btnClick)="onEdit()"
                [appearance]="'stroked'"
                ></app-button>
                <app-button
                class="action-btn delete-btn"
                [fontIcon]="'delete'"
                title="Delete"
                (btnClick)="onDelete()"
                [appearance]="'stroked'"
                ></app-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Form Mode Content -->
    @if (!isViewMode) {
      <div class="dialog-content">
        @if (mode === 'edit') {
          <p class="dialog-subtitle">Update the details below and save your changes.</p>
        }
        <form [formGroup]="dietForm" (ngSubmit)="onSubmit()" class="diet-form">
          <!-- Basic Info Card -->
          <section class="form-card form-card--basic">
            <div class="section-header">
              <mat-icon class="section-icon" aria-hidden="true">restaurant</mat-icon>
              <h3 class="section-title">Basic information</h3>
            </div>
            <div class="form-card-body">
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Name *</mat-label>
                  <input matInput formControlName="name" placeholder="Enter diet name">
                  @if (dietForm.get('name')?.hasError('required')) {
                    <mat-error>Name is required</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <textarea matInput formControlName="description"
                    placeholder="Enter diet description"
                    rows="3"
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="3"
                    cdkAutosizeMaxRows="5"></textarea>
                  @if (dietForm.get('description')?.hasError('required')) {
                    <mat-error>Description is required</mat-error>
                  }
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Diet Type</mat-label>
                  <mat-select formControlName="dietType">
                    <mat-option value="MEDITERRANEAN">Mediterranean</mat-option>
                    <mat-option value="KETO">Keto</mat-option>
                    <mat-option value="VEGAN">Vegan</mat-option>
                    <mat-option value="VEGETARIAN">Vegetarian</mat-option>
                    <mat-option value="PALEO">Paleo</mat-option>
                    <mat-option value="LOW_CARB">Low Carb</mat-option>
                    <mat-option value="HIGH_PROTEIN">High Protein</mat-option>
                  </mat-select>
                  @if (dietForm.get('dietType')?.hasError('required')) {
                    <mat-error>Diet type is required</mat-error>
                  }
                </mat-form-field>
              </div>
            </div>
          </section>

          <!-- Nutritional Information Card -->
          <section class="form-card form-card--nutrition">
            <div class="section-header">
              <mat-icon class="section-icon" aria-hidden="true">monitor_heart</mat-icon>
              <h3 class="section-title">Nutritional information</h3>
            </div>
            <div class="form-card-body">
              <div class="nutrition-grid">
            <div class="form-field-group">
              <mat-form-field appearance="outline">
                <mat-label>Calories (kcal)</mat-label>
                <input matInput formControlName="calories" type="number" placeholder="0">
                @if (dietForm.get('calories')?.hasError('required')) {
                  <mat-error>
                    Calories is required
                  </mat-error>
                }
              </mat-form-field>
            </div>
            <div class="form-field-group">
              <mat-form-field appearance="outline">
                <mat-label>Protein (g)</mat-label>
                <input matInput formControlName="protein" type="number" placeholder="0">
                @if (dietForm.get('protein')?.hasError('required')) {
                  <mat-error>
                    Protein is required
                  </mat-error>
                }
              </mat-form-field>
            </div>
            <div class="form-field-group">
              <mat-form-field appearance="outline">
                <mat-label>Carbohydrates (g)</mat-label>
                <input matInput formControlName="carbs" type="number" placeholder="0">
                @if (dietForm.get('carbs')?.hasError('required')) {
                  <mat-error>
                    Carbohydrates is required
                  </mat-error>
                }
              </mat-form-field>
            </div>
            <div class="form-field-group">
              <mat-form-field appearance="outline">
                <mat-label>Fat (g)</mat-label>
                <input matInput formControlName="fat" type="number" placeholder="0">
                @if (dietForm.get('fat')?.hasError('required')) {
                  <mat-error>
                    Fat is required
                  </mat-error>
                }
              </mat-form-field>
            </div>
            <div class="form-field-group">
              <mat-form-field appearance="outline">
                <mat-label>Fiber (g)</mat-label>
                <input matInput formControlName="fiber" type="number" placeholder="0">
                @if (dietForm.get('fiber')?.hasError('required')) {
                  <mat-error>Fiber is required</mat-error>
                }
              </mat-form-field>
            </div>
              </div>
            </div>
          </section>

          <!-- Media & Image Card -->
          <section class="form-card form-card--media">
            <div class="section-header">
              <mat-icon class="section-icon" aria-hidden="true">perm_media</mat-icon>
              <h3 class="section-title">Media & image</h3>
            </div>
            <div class="form-card-body">
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>YouTube URL</mat-label>
                  <input matInput formControlName="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
                  <mat-icon matSuffix>video_library</mat-icon>
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Document URL (PDF)</mat-label>
                  <input matInput formControlName="documentUrl" placeholder="https://.../doc.pdf">
                  <mat-icon matSuffix>description</mat-icon>
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Image URL</mat-label>
                  <input matInput formControlName="imageUrl" placeholder="https://images.unsplash.com/...">
                  <mat-icon matSuffix>image</mat-icon>
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <div class="upload-section">
                  <span class="upload-label">Or upload image file</span>
                  <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" class="file-input-hidden" aria-label="Upload diet image">
                  <button type="button"
                    class="file-upload-area"
                    (click)="fileInput.click()"
                    (dragover)="onDragOver($event)"
                    (drop)="onDrop($event)">
                    <mat-icon>cloud_upload</mat-icon>
                    <span>Drag and drop or click to choose</span>
                    @if (selectedFileName) {
                      <span class="file-name">{{ selectedFileName }}</span>
                    }
                    @if (!selectedFileName) {
                      <span class="file-name placeholder">No file chosen</span>
                    }
                  </button>
                </div>
              </div>
              @if (imagePreview || dietForm.get('imageUrl')?.value) {
                <div class="form-field-group image-preview-wrap">
                  <span class="preview-label">Preview</span>
                  <div class="image-preview">
                    <img [src]="imagePreview || dietForm.get('imageUrl')?.value"
                      alt="Diet preview"
                      (error)="onImageError($event)">
                  </div>
                </div>
              }
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Tags (comma separated)</mat-label>
                  <input matInput formControlName="tags" placeholder="lunch, quick, healthy">
                  <mat-icon matSuffix>local_offer</mat-icon>
                </mat-form-field>
              </div>
            </div>
          </section>

          <!-- Ingredients Card -->
          <section class="form-card form-card--ingredients">
            <div class="section-header section-header--with-action">
              <div class="section-header-left">
                <mat-icon class="section-icon" aria-hidden="true">list</mat-icon>
                <h3 class="section-title">Ingredients</h3>
              </div>
              <app-button
                class="add-ingredient-btn"
                [fontIcon]="'add'"
                [text]="'Add ingredient'"
                [appearance]="'stroked'"
                (btnClick)="addIngredient()">
              </app-button>
            </div>
            <div class="form-card-body">
              <div class="ingredients-container" formArrayName="ingredients">
                @for (ingredient of ingredientsArray.controls; track ingredient; let i = $index) {
                  <div class="ingredient-item" [formGroupName]="i">
                    <div class="ingredient-header">
                      <span class="ingredient-number">Ingredient {{ i + 1 }}</span>
                      <app-button
                        class="remove-ingredient-btn"
                        [fontIcon]="'delete'"
                        [color]="'warn'"
                        [appearance]="'icon'"
                        (btnClick)="removeIngredient(i)">
                      </app-button>
                    </div>
                  <div class="ingredient-fields">
                    <div class="form-field-group">
                      <mat-form-field appearance="outline">
                        <mat-label>Name *</mat-label>
                        <input matInput formControlName="name" placeholder="e.g., Quinoa">
                        @if (ingredient.get('name')?.hasError('required')) {
                          <mat-error>
                            Name is required
                          </mat-error>
                        }
                      </mat-form-field>
                    </div>
                    <div class="form-field-group">
                      <mat-form-field appearance="outline">
                        <mat-label>Quantity *</mat-label>
                        <input matInput formControlName="quantity" type="number" placeholder="1">
                        @if (ingredient.get('quantity')?.hasError('required')) {
                          <mat-error>
                            Quantity is required
                          </mat-error>
                        }
                      </mat-form-field>
                    </div>
                    <div class="form-field-group">
                      <mat-form-field appearance="outline">
                        <mat-label>Unit *</mat-label>
                        <mat-select formControlName="unit">
                          <mat-option value="CUP">Cup</mat-option>
                          <mat-option value="TBSP">Tablespoon</mat-option>
                          <mat-option value="TSP">Teaspoon</mat-option>
                          <mat-option value="GRAM">Gram</mat-option>
                          <mat-option value="KG">Kilogram</mat-option>
                          <mat-option value="ML">Milliliter</mat-option>
                          <mat-option value="L">Liter</mat-option>
                          <mat-option value="PIECE">Piece</mat-option>
                          
                        </mat-select>
                        @if (ingredient.get('unit')?.hasError('required')) {
                          <mat-error>
                            Unit is required
                          </mat-error>
                        }
                      </mat-form-field>
                    </div>
                    <div class="form-field-group">
                      <mat-form-field appearance="outline">
                        <mat-label>Category</mat-label>
                        <mat-select formControlName="category">
                          <mat-option value="GRAINS">Grains</mat-option>
                          <mat-option value="PROTEIN">Protein</mat-option>
                          <mat-option value="VEGETABLES">Vegetables</mat-option>
                          <mat-option value="FRUITS">Fruits</mat-option>
                          <mat-option value="LEGUMES">Legumes</mat-option>
                          <mat-option value="OILS">Oils</mat-option>
                          
                        </mat-select>
                      </mat-form-field>
                    </div>
                    <div class="form-field-group">
                      <mat-form-field appearance="outline">
                        <mat-label>Notes</mat-label>
                        <input matInput formControlName="notes" placeholder="Optional notes">
                      </mat-form-field>
                    </div>
                  </div>
                  </div>
                }
              </div>
            </div>
          </section>

          <!-- Recipe Card -->
          <section class="form-card form-card--recipe">
            <div class="section-header">
              <mat-icon class="section-icon" aria-hidden="true">menu_book</mat-icon>
              <h3 class="section-title">Recipe</h3>
            </div>
            <div class="form-card-body">
              <div class="recipe-fields">
              <div class="recipe-meta-grid">
                <div class="form-field-group">
                  <mat-form-field appearance="outline">
                    <mat-label>Prep Time (minutes)</mat-label>
                    <input matInput formControlName="prepTime" type="number" placeholder="15">
                  </mat-form-field>
                </div>
                <div class="form-field-group">
                  <mat-form-field appearance="outline">
                    <mat-label>Cook Time (minutes)</mat-label>
                    <input matInput formControlName="cookTime" type="number" placeholder="20">
                  </mat-form-field>
                </div>
                <div class="form-field-group">
                  <mat-form-field appearance="outline">
                    <mat-label>Servings</mat-label>
                    <input matInput formControlName="servings" type="number" placeholder="4">
                  </mat-form-field>
                </div>
                <div class="form-field-group">
                  <mat-form-field appearance="outline">
                    <mat-label>Difficulty</mat-label>
                    <mat-select formControlName="difficulty">
                      <mat-option value="EASY">Easy</mat-option>
                      <mat-option value="MEDIUM">Medium</mat-option>
                      <mat-option value="HARD">Hard</mat-option>
                      
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Instructions (one per line)</mat-label>
                  <textarea matInput formControlName="instructions"
                    placeholder="1. Rinse quinoa thoroughly under cold water&#10;2. Cook quinoa according to package instructions&#10;3. Drain and rinse chickpeas, set aside"
                    rows="6"
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="6"
                  cdkAutosizeMaxRows="12"></textarea>
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Cooking Tips (one per line)</mat-label>
                  <textarea matInput formControlName="tips"
                    placeholder="You can prepare quinoa ahead of time and store in refrigerator&#10;Add more vegetables for extra nutrition and color&#10;Season with salt and pepper to taste"
                    rows="4"
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="4"
                  cdkAutosizeMaxRows="8"></textarea>
                </mat-form-field>
              </div>
              <div class="form-field-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Recipe Notes</mat-label>
                  <textarea matInput formControlName="notes"
                    placeholder="This recipe is perfect for meal prep and can be stored for up to 3 days in the refrigerator."
                    rows="3"
                    cdkTextareaAutosize
                    cdkAutosizeMinRows="3"
                    cdkAutosizeMaxRows="6"></textarea>
                </mat-form-field>
              </div>
              </div>
            </div>
          </section>

          <div class="form-actions">
              <app-button
                [fontIcon]="'save'"
                [text]="mode === 'edit' ? 'Save Changes' : 'Create Diet'"
                color="primary"
                appearance="raised"
                (btnClick)="onSubmit()">
              </app-button>
            </div>
          </form>
        </div>
      }
    </div>
