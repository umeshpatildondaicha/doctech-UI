<app-page [breadcrumb]="breadcrumb" [isFooter]="false">
  <div page-body class="hospital-page">
    <div class="hp-layout">
      <main class="hp-canvas-wrap">
        <!-- Floating action bar -->
        <div class="topbar topbar--sm" aria-label="Flow actions">
          <button mat-icon-button class="tb-btn tb-plus" type="button"
            [class.tb-active]="showNodePicker()"
            (click)="toggleNodePicker()"
            matTooltip="Add node" matTooltipPosition="below">
            <mat-icon>add</mat-icon>
          </button>

          <span class="tb-sep" aria-hidden="true"></span>

          <button mat-icon-button class="tb-btn" type="button"
            [class.tb-active]="linkMode()"
            (click)="toggleLinkMode()"
            matTooltip="Link nodes" matTooltipPosition="below">
            <mat-icon>{{ linkMode() ? 'link' : 'add_link' }}</mat-icon>
          </button>

          <button mat-icon-button class="tb-btn" type="button" (click)="autoArrange()"
            matTooltip="Auto arrange" matTooltipPosition="below">
            <mat-icon>auto_fix_high</mat-icon>
          </button>

          <span class="tb-sep" aria-hidden="true"></span>

          <button mat-icon-button class="tb-btn" type="button" (click)="load()"
            matTooltip="Reload" matTooltipPosition="below">
            <mat-icon>refresh</mat-icon>
          </button>
          <button mat-icon-button class="tb-btn" type="button" (click)="save()"
            matTooltip="Save" matTooltipPosition="below">
            <mat-icon>save</mat-icon>
          </button>
          <button mat-icon-button class="tb-btn" type="button" (click)="reset()"
            matTooltip="Reset" matTooltipPosition="below">
            <mat-icon>delete</mat-icon>
          </button>
        </div>

        <!-- Node picker panel -->
        @if (showNodePicker()) {
          <aside class="node-picker" aria-label="Add node panel">
            <div class="np-head">
              <span class="np-title">Components</span>
              <button type="button" class="np-close" (click)="toggleNodePicker()">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <div class="np-search">
              <mat-icon class="np-search-ico">search</mat-icon>
              <input class="np-search-input" type="text" placeholder="Search..." [(ngModel)]="pickerSearch" />
            </div>

            <div class="np-tabs">
              <button type="button" class="np-tab" [class.active]="pickerCategory() === 'all'" (click)="setPickerCategory('all')">All</button>
              <button type="button" class="np-tab" [class.active]="pickerCategory() === 'department'" (click)="setPickerCategory('department')">Depts</button>
              <button type="button" class="np-tab" [class.active]="pickerCategory() === 'subdepartment'" (click)="setPickerCategory('subdepartment')">Sub-depts</button>
              <button type="button" class="np-tab" [class.active]="pickerCategory() === 'doctor'" (click)="setPickerCategory('doctor')">Doctors</button>
              <button type="button" class="np-tab" [class.active]="pickerCategory() === 'staff'" (click)="setPickerCategory('staff')">Staff</button>
            </div>

            <div class="np-list">
              @for (item of pickerItems(); track item.id + item.type) {
                <button
                  type="button"
                  class="np-item"
                  [class.disabled]="pickerItemDisabled(item.type)"
                  [disabled]="pickerItemDisabled(item.type)"
                  (click)="addFromPicker(item)"
                  [title]="pickerItemDisabled(item.type) ? pickerItemHint(item.type) : 'Drag or click to add ' + item.name"
                  draggable="true"
                  (dragstart)="onPickerDragStart($event, item)"
                >
                  <div class="np-item-ico" [attr.data-type]="item.type">
                    <img [src]="item.icon" class="np-ico-img" alt="" />
                  </div>
                  <div class="np-item-info">
                    <div class="np-item-name">{{ item.name }}</div>
                    @if (item.sub) {
                      <div class="np-item-sub">{{ item.sub }}</div>
                    }
                  </div>
                  <mat-icon class="np-item-grip">drag_indicator</mat-icon>
                </button>
              }
              @if (pickerItems().length === 0) {
                <div class="np-empty">No items found.</div>
              }
            </div>

            <div class="np-footer">
              <button type="button" class="np-new-staff" (click)="toggleAddStaffForm(); toggleNodePicker()">
                <mat-icon>person_add</mat-icon>
                <span>Create new staff</span>
              </button>
            </div>
          </aside>
        }

        <!-- Canvas (pan + zoom, no scrollbars) -->
        <div
          #canvasEl
          class="hp-canvas"
          [class.panning]="isPanning()"
          (wheel)="onCanvasWheel($event)"
          (mousedown)="onCanvasMouseDown($event)"
          (dragover)="onCanvasDragOver($event)"
          (drop)="onCanvasDrop($event)"
          aria-label="Flow canvas"
        >
          <div
            class="canvas-inner"
            [style.width.px]="canvasWidth()"
            [style.height.px]="canvasHeight()"
            [style.transform]="canvasTransform()"
            [style.transformOrigin]="'0 0'"
          >
              <!-- SVG edges with flowing animation -->
              <svg class="edges" [attr.width]="canvasWidth()" [attr.height]="canvasHeight()">
                <defs>
                  <!-- Source connector (small rounded rect) -->
                  <marker id="conn-src" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                    <rect x="1" y="1" width="6" height="6" rx="1.5" fill="rgba(160,174,192,0.75)" />
                  </marker>
                  <marker id="conn-src-sel" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                    <rect x="1" y="1" width="6" height="6" rx="1.5" fill="rgba(239,68,68,0.75)" />
                  </marker>
                  <!-- Destination connector (small rounded rect) -->
                  <marker id="conn-dst" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                    <rect x="1" y="1" width="6" height="6" rx="1.5" fill="rgba(160,174,192,0.75)" />
                  </marker>
                  <marker id="conn-dst-sel" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto" markerUnits="userSpaceOnUse">
                    <rect x="1" y="1" width="6" height="6" rx="1.5" fill="rgba(239,68,68,0.75)" />
                  </marker>
                </defs>
                @for (e of edges(); track e.id) {
                  <!-- Invisible wide hit-area for clicking -->
                  <path
                    class="edge-hit"
                    [attr.d]="edgePath(e)"
                    (click)="selectEdge(e.id); $event.stopPropagation()"
                  ></path>
                  <!-- Glow/shadow layer -->
                  <path
                    class="edge edge-glow"
                    [attr.d]="edgePath(e)"
                    [class.sel]="selectedEdgeId() === e.id"
                  ></path>
                  <!-- Main dashed line with rectangle connectors at both ends -->
                  <path
                    class="edge edge-bg"
                    [attr.d]="edgePath(e)"
                    [class.sel]="selectedEdgeId() === e.id"
                    [attr.marker-start]="selectedEdgeId() === e.id ? 'url(#conn-src-sel)' : 'url(#conn-src)'"
                    [attr.marker-end]="selectedEdgeId() === e.id ? 'url(#conn-dst-sel)' : 'url(#conn-dst)'"
                  ></path>
                  <!-- Animated flow highlight -->
                  <path
                    class="edge edge-flow"
                    [attr.d]="edgePath(e)"
                    [class.sel]="selectedEdgeId() === e.id"
                  ></path>
                }
              </svg>

              <!-- Delete button at selected edge midpoint -->
              @if (selectedEdgeId(); as eid) {
                @for (e of edges(); track e.id) {
                  @if (e.id === eid) {
                    @if (edgeMidpoint(e); as mid) {
                      <button
                        type="button"
                        class="edge-del-btn"
                        [style.left.px]="mid.x"
                        [style.top.px]="mid.y"
                        (click)="removeEdgeById(e.id); $event.stopPropagation()"
                        title="Remove link"
                      >
                        <mat-icon>close</mat-icon>
                      </button>
                    }
                  }
                }
              }

              <!-- Nodes (unified design) -->
              @for (n of nodes(); track n.id) {
                <button
                  type="button"
                  class="node"
                  [class.sel]="selectedNodeId() === n.id"
                  [class.link-source]="linkSourceId() === n.id"
                  [class.link-mode]="linkMode()"
                  [class.dragging]="isDragging()"
                  [style.left.px]="n.x"
                  [style.top.px]="n.y"
                  [style.height.px]="nodeHeight(n.type)"
                  (mousedown)="onNodeMouseDown($event, n)"
                  (click)="selectNode(n.id)"
                  [attr.aria-label]="n.title"
                  [title]="n.title"
                >
                  <div class="n-ico" [style.background]="nodeColor(n.type)">
                    <img [src]="nodeIcon(n.type)" class="n-ico-img" alt="" />
                  </div>
                  <div class="n-text">
                    <div class="n-title">{{ n.title }}</div>
                    <div class="n-sub">{{ n.subtitle || nodeLabel(n) }}</div>
                  </div>
                  @if (n.type === 'hospital') {
                    <span class="feat-badge" [matTooltip]="hospitalFeatureCount() + ' features enabled'" matTooltipPosition="above">
                      <mat-icon class="feat-badge-ico">widgets</mat-icon>
                      <span>{{ hospitalFeatureCount() }}</span>
                    </span>
                  } @else if (n.type === 'doctor') {
                    <span class="feat-badge feat-badge--doc" [matTooltip]="doctorFeatureCount(n.entityId) + ' / ' + hospitalFeatureCount() + ' features'" matTooltipPosition="above">
                      <mat-icon class="feat-badge-ico">widgets</mat-icon>
                      <span>{{ doctorFeatureCount(n.entityId) }}/{{ hospitalFeatureCount() }}</span>
                    </span>
                  } @else {
                    <span class="n-dot" [style.background]="nodeColor(n.type)"></span>
                  }
                </button>
              }
            </div>
        </div>

        <!-- Link mode banner -->
        @if (linkMode()) {
          <div class="link-banner">
            @if (!linkSourceId()) {
              <mat-icon>touch_app</mat-icon>
              <span>Click the <strong>source</strong> node</span>
            } @else {
              <mat-icon>arrow_forward</mat-icon>
              <span>Now click the <strong>target</strong> node</span>
            }
            <button mat-icon-button type="button" class="link-banner-close" (click)="cancelLinkMode()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }

        <!-- Add new staff form -->
        @if (showAddStaffForm()) {
          <div class="add-staff-panel">
            <div class="asp-head">
              <mat-icon>person_add</mat-icon>
              <span>Add New Staff</span>
              <button mat-icon-button type="button" class="asp-close" (click)="toggleAddStaffForm()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div class="asp-body">
              <mat-form-field appearance="outline" class="asp-field">
                <mat-label>Full Name</mat-label>
                <input matInput [(ngModel)]="newStaffName" placeholder="e.g. John Doe" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="asp-field">
                <mat-label>Role</mat-label>
                <mat-select [(ngModel)]="newStaffRole">
                  <mat-option value="Nurse">Nurse</mat-option>
                  <mat-option value="Reception">Reception</mat-option>
                  <mat-option value="Lab Tech">Lab Tech</mat-option>
                  <mat-option value="Billing">Billing</mat-option>
                  <mat-option value="Pharmacist">Pharmacist</mat-option>
                  <mat-option value="General">General</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="asp-footer">
              <button mat-button type="button" (click)="toggleAddStaffForm()">Cancel</button>
              <button mat-flat-button color="primary" type="button" [disabled]="!newStaffName.trim()" (click)="createNewStaff()">
                Add Staff
              </button>
            </div>
          </div>
        }

        <!-- Bottom-right zoom -->
        <div class="zoom-fab zoom-fab--sm" aria-label="Canvas zoom controls">
          <button mat-icon-button class="zm-btn" type="button" (click)="zoomOut()"
            matTooltip="Zoom out" matTooltipPosition="above">
            <mat-icon>remove</mat-icon>
          </button>
          <div class="zoom-pct">{{ zoomPercent() }}%</div>
          <button mat-icon-button class="zm-btn" type="button" (click)="zoomIn()"
            matTooltip="Zoom in" matTooltipPosition="above">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <!-- Floating right configuration panel -->
        @if (showConfigPanel()) {
          <aside class="config-drawer" aria-label="Configuration panel">
            <div class="cd-head">
              <div class="cd-title">Configuration</div>
              <button mat-icon-button type="button" (click)="toggleConfigPanel()" aria-label="Close configuration panel">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div class="cd-body">
              @if (selectedNode(); as n) {
                <!-- Profile card for doctor/staff -->
                @if (n.type === 'doctor' || n.type === 'staff') {
                  <div class="profile-card">
                    <div class="profile-avatar" [class.avatar-doctor]="n.type === 'doctor'" [class.avatar-staff]="n.type === 'staff'">
                      {{ getInitials(n.title) }}
                    </div>
                    <div class="profile-info">
                      <div class="profile-name">{{ n.title }}</div>
                      <div class="profile-type"><span class="pill pill--{{ n.type }}">{{ n.type }}</span></div>
                      @if (n.subtitle) { <div class="profile-sub">{{ n.subtitle }}</div> }
                    </div>
                  </div>
                } @else {
                  <div class="cfg-section cfg-section--first">
                    <div class="cfg-k">Selected</div>
                    <div class="cfg-v"><span class="pill pill--{{ n.type }}">{{ n.type }}</span> {{ n.title }}</div>
                    @if (n.subtitle) { <div class="cfg-help">{{ n.subtitle }}</div> }
                  </div>
                }

                <!-- Features section (hospital) -->
                @if (n.type === 'hospital') {
                  <div class="cfg-section">
                    <div class="cfg-k">Features ({{ hospitalFeatureCount() }} enabled)</div>
                    <div class="feat-list">
                      @for (f of allFeatures(); track f.id) {
                        <div class="feat-row" (click)="toggleHospitalFeature(f.id)">
                          <mat-checkbox
                            [checked]="isHospitalFeatureEnabled(f.id)"
                            (click)="$event.stopPropagation()"
                            (change)="toggleHospitalFeature(f.id)"
                            color="primary"
                          ></mat-checkbox>
                          <mat-icon class="feat-row-ico">{{ f.icon }}</mat-icon>
                          <span class="feat-row-name">{{ f.name }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }

                <!-- Features section (doctor â€” from hospital's enabled features) -->
                @if (n.type === 'doctor') {
                  <div class="cfg-section">
                    <div class="cfg-k">Features ({{ doctorFeatureCount(n.entityId) }} / {{ hospitalFeatureCount() }})</div>
                    @if (hospitalFeatures().length === 0) {
                      <div class="empty">No features enabled at hospital level.</div>
                    } @else {
                      <div class="feat-list">
                        @for (f of hospitalFeatures(); track f.id) {
                          <div class="feat-row" (click)="toggleDoctorFeature(n.entityId, f.id)">
                            <mat-checkbox
                              [checked]="isDoctorFeatureEnabled(n.entityId, f.id)"
                              (click)="$event.stopPropagation()"
                              (change)="toggleDoctorFeature(n.entityId, f.id)"
                              color="primary"
                            ></mat-checkbox>
                            <mat-icon class="feat-row-ico">{{ f.icon }}</mat-icon>
                            <span class="feat-row-name">{{ f.name }}</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

                <!-- Children list -->
                @if (n.type !== 'staff') {
                  <div class="cfg-section">
                    <div class="cfg-k">{{ childTypeLabel(n.type) }}</div>
                    @if (selectedNodeChildren().length === 0) {
                      <div class="empty">No {{ childTypeLabel(n.type) | lowercase }} connected yet.</div>
                    } @else {
                      <div class="list">
                        @for (child of selectedNodeChildren(); track child.id) {
                          <button type="button" class="row" [class.row--selected]="selectedNodeId() === child.id" (click)="selectNode(child.id); $event.stopPropagation()">
                            @if (child.type === 'doctor' || child.type === 'staff') {
                              <div class="row-avatar" [class.avatar-doctor]="child.type === 'doctor'" [class.avatar-staff]="child.type === 'staff'">
                                {{ getInitials(child.title) }}
                              </div>
                            }
                            <div class="row-main">
                              <div class="row-t">{{ child.title }}</div>
                              @if (child.subtitle) { <div class="row-s">{{ child.subtitle }}</div> }
                            </div>
                            <button mat-icon-button type="button" (click)="removeConnection(n.id, child.id); $event.stopPropagation()" title="Disconnect">
                              <mat-icon>link_off</mat-icon>
                            </button>
                          </button>
                        }
                      </div>
                    }
                  </div>
                }
              } @else {
                <div class="empty">Select a node on the canvas to configure it.</div>
              }
            </div>
          </aside>
        }
      </main>
    </div>
  </div>
</app-page>
