<app-page [breadcrumb]="breadcrumb" [isFooter]="false">
  <div page-body class="roles-management-page">
    <!-- Page Header -->
    <app-admin-page-header title="Roles & Staff Management" subtitle="Comprehensive role and staff management system"
      [actions]="headerActions" (actionClicked)="onHeaderAction($event)">
    </app-admin-page-header>

    <!-- Navigation Tabs -->
    <app-admin-tabs size="medium" variant="line" >
    </app-admin-tabs>

    <!-- Bulk Actions Toolbar -->
    <!-- @if (showBulkActions) {
      <div class="bulk-actions-toolbar">
        <div class="selected-count">{{ bulkSelectedStaff.size }} staff members selected</div>
        <div class="bulk-actions">
          <app-selectbox [label]="'Assign to Doctor'" [options]="doctorOptions" [valueField]="'value'"
            [displayExpr]="'label'" (dataChange)="bulkAssignToDoctor($event)" class="bulk-assign-select">
          </app-selectbox>
          <app-button [text]="'Remove All'" [color]="'warn'" [fontIcon]="'remove'" class="bulk-remove-btn">
          </app-button>
          <app-button [text]="'Clear Selection'" [color]="'accent'" [fontIcon]="'clear'" (btnClick)="clearSelection()"
            class="clear-selection-btn">
          </app-button>
        </div>
      </div>
    } -->
    <!-- -----Tab Content ------------>
    <app-tabs [selectedIndex]="selectedTabIndex" class="tabs-content">
      <!-- Overview Tab -->
      <app-tab label="overview">
        <div class="overview-dashboard">
          <!-- Statistics Cards -->
          <app-admin-stats-card [stats]="statsCards">
          </app-admin-stats-card>

          <!-- Role Distribution -->
          <div class="dashboard-grid">
            <div class="dashboard-card roles-card">
              <div class="card-header">
                <h3>Role Distribution</h3>
                <!-- <app-button [fontIcon]="'visibility'" [color]="'accent'"
              (btnClick)="setActiveTab('permissions')"></app-button> -->
            </div>
            <div class="roles-overview">
              @for (role of roles; track role) {
                <div class="role-overview-item">
                  <div class="role-icon-small" [style.background-color]="role.color">
                    <app-icon [fontIcon]="role.icon" [size]="16"></app-icon>
                  </div>
                  <div class="role-info-small">
                    <div class="role-name-small">{{ role.name }}</div>
                    <div class="role-count-small">{{ getStaffCountForRole(role.name) }} staff</div>
                  </div>
                  <div class="role-percentage">
                    {{ ((getStaffCountForRole(role.name) / staff.length) * 100).toFixed(1) }}%
                  </div>
                </div>
              }
            </div>
          </div>

          <div class="dashboard-card quick-actions-card">
            <div class="card-header">
              <h3>Quick Actions</h3>
            </div>
            <div class="quick-actions">
              <app-button [text]="'Manage Assignments'" [color]="'accent'" [fontIcon]="'assignment_ind'"
                (btnClick)="setActiveTab('assignments')" class="quick-action-btn">
              </app-button>
              <app-button [text]="'Export Reports'" [color]="'accent'" [fontIcon]="'download'"
                (btnClick)="exportReports()" class="quick-action-btn">
              </app-button>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-card activity-card">
          <div class="card-header">
            <h3>Recent Activity</h3>
            <div class="activity-filters">
              <app-button [text]="'Today'" [color]="'accent'" class="filter-btn active"></app-button>
              <app-button [text]="'Week'" [color]="'accent'" class="filter-btn"></app-button>
              <app-button [text]="'Month'" [color]="'accent'" class="filter-btn"></app-button>
            </div>
          </div>
          <div class="activity-list">
            <div class="activity-item">
              <div class="activity-icon">
                <app-icon [fontIcon]="'person_add'" [size]="16"></app-icon>
              </div>
              <div class="activity-content">
                <div class="activity-text">New nurse Emily Davis added to ICU team</div>
                <div class="activity-time">2 hours ago</div>
              </div>
            </div>
            <div class="activity-item">
              <div class="activity-icon">
                <app-icon [fontIcon]="'assignment_turned_in'" [size]="16"></app-icon>
              </div>
              <div class="activity-content">
                <div class="activity-text">Dr. Sarah Johnson assigned 3 new staff members</div>
                <div class="activity-time">4 hours ago</div>
              </div>
            </div>
            <div class="activity-item">
              <div class="activity-icon">
                <app-icon [fontIcon]="'schedule'" [size]="16"></app-icon>
              </div>
              <div class="activity-content">
                <div class="activity-text">Morning shift attendance completed - 95% present</div>
                <div class="activity-time">6 hours ago</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </app-tab>




    <!-- Role Permissions Tab -->
    <app-tab label="permissions">

      <div class="permissions-management">
        <div class="permissions-sidebar">
          <div class="sidebar-header">
            <h3>Hospital Roles</h3>
            <div class="role-count">{{ roles.length }} Roles</div>
          </div>
          <div class="roles-list">
            @for (role of roles; track role) {
              <div class="role-item" [class.selected]="selectedRole?.id === role.id"
                (click)="selectRole(role)">
                <div class="role-icon" [style.background-color]="role.color">
                  <app-icon [fontIcon]="role.icon" [size]="20"></app-icon>
                </div>
                <div class="role-details">
                  <div class="role-name">{{ role.name }}</div>
                  <div class="role-description">{{ role.description }}</div>
                </div>
                <div class="role-badge">
                  <div class="staff-count">{{ getStaffCountForRole(role.name) }}</div>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="permissions-main">
          @if (selectedRole) {
            <div class="permissions-header">
              <div class="selected-role-info">
                <div class="selected-role-icon" [style.background-color]="selectedRole.color">
                  <app-icon [fontIcon]="selectedRole.icon" [size]="24"></app-icon>
                </div>
                <div class="selected-role-details">
                  <h2>{{ selectedRole.name }} Permissions</h2>
                  <p>{{ selectedRole.description }}</p>
                </div>
              </div>
              <div class="permissions-actions">
                <app-button [text]="'Reset to Default'" [color]="'accent'" [fontIcon]="'refresh'"></app-button>
                <app-button [text]="'Save Changes'" [color]="'primary'" [fontIcon]="'save'"></app-button>
              </div>
            </div>
          }

          @if (selectedRole) {
            <div class="permissions-content">
              <div class="permissions-grid">
                <div class="permission-header">
                  <span>Module</span>
                  <span>Read</span>
                  <span>Write</span>
                  <span>Update</span>
                  <span>Delete</span>
                </div>
                @for (module of moduleOptions; track module) {
                  <div class="permission-row">
                    <div class="module-info">
                      <app-icon [fontIcon]="module.icon" [size]="20"></app-icon>
                      <div class="module-details">
                        <div class="module-name">{{ module.label }}</div>
                        <div class="module-description">Manage {{ module.label.toLowerCase() }} access</div>
                      </div>
                    </div>
                    <div class="permission-checkboxes">
                      <label class="permission-toggle">
                        <input type="checkbox" [checked]="getPermissionValue(module.key, 'read')"
                          (change)="updatePermission(module.key, 'read', $event)">
                          <span class="toggle-slider"></span>
                        </label>
                        <label class="permission-toggle">
                          <input type="checkbox" [checked]="getPermissionValue(module.key, 'write')"
                            (change)="updatePermission(module.key, 'write', $event)">
                            <span class="toggle-slider"></span>
                          </label>
                          <label class="permission-toggle">
                            <input type="checkbox" [checked]="getPermissionValue(module.key, 'update')"
                              (change)="updatePermission(module.key, 'update', $event)">
                              <span class="toggle-slider"></span>
                            </label>
                            <label class="permission-toggle">
                              <input type="checkbox" [checked]="getPermissionValue(module.key, 'delete')"
                                (change)="updatePermission(module.key, 'delete', $event)">
                                <span class="toggle-slider"></span>
                              </label>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }

                  @if (!selectedRole) {
                    <div class="no-role-selected">
                      <app-icon [fontIcon]="'security'" [size]="48"></app-icon>
                      <h3>Select a Role</h3>
                      <p>Choose a role from the sidebar to manage its permissions</p>
                    </div>
                  }
                </div>
              </div>

            </app-tab>


              <!-- Assignments Tab -->
              <app-tab label="assignments">

                <div class="assignments-management">
                  <div class="assignments-header">
                    <h2>Staff-Doctor Assignments</h2>
                    <div class="assignment-actions">
                      <app-button [text]="'Bulk Assign'" [color]="'primary'" [fontIcon]="'group_add'"
                        (btnClick)="openBulkAssignDialog()" class="bulk-assign-btn">
                      </app-button>
                      <app-button [text]="'Assignment Rules'" [color]="'accent'" [fontIcon]="'rule'" class="rules-btn">
                      </app-button>
                    </div>
                  </div>

                  <div class="assignments-content">
                    <div class="doctors-assignments">
                      @for (doctor of doctors; track doctor) {
                        <div class="doctor-assignment-card">
                          <div class="doctor-header">
                            <div class="doctor-info">
                              <div class="doctor-avatar">
                                <app-icon [fontIcon]="'local_hospital'" [size]="24" [color]="'white'"></app-icon>
                              </div>
                              <div class="doctor-details">
                                <div class="doctor-name">{{ doctor.name }}</div>
                                <div class="doctor-specialization">{{ doctor.specialization }}</div>
                                <div class="doctor-department">{{ doctor.department }}</div>
                              </div>
                            </div>
                            <div class="assignment-stats">
                              <div class="assigned-count">{{ getStaffCountForDoctor(doctor.id) }} Staff Assigned</div>
                              <app-button [text]="'Assign Staff'" [color]="'primary'" [fontIcon]="'person_add'"
                                (btnClick)="openAssignmentDialog(doctor)" class="assign-btn">
                              </app-button>
                            </div>
                          </div>
                          <div class="assigned-staff-list">
                            @for (staffMember of getStaffForDoctor(doctor.id); track staffMember) {
                              <div class="assigned-staff-item">
                                <div class="staff-info">
                                  <div class="staff-avatar-small">
                                    <app-icon [fontIcon]="'person'" [size]="16"></app-icon>
                                    <div class="status-dot"
                                      [style.background-color]="getAttendanceStatusColor(staffMember.attendance.status)">
                                    </div>
                                  </div>
                                  <div class="staff-details">
                                    <div class="staff-name">{{ staffMember.fullName }}</div>
                                    <div class="staff-role">{{ staffMember.role }}</div>
                                  </div>
                                </div>
                                <div class="staff-schedule">
                                  <div class="shift-info">{{ staffMember.shift.start }} - {{ staffMember.shift.end }}</div>
                                  <div class="days-info">{{ staffMember.shift.days.length }} days/week</div>
                                </div>
                                <div class="assignment-actions">
                                  <app-button [fontIcon]="'schedule'" [color]="'accent'" (btnClick)="viewSchedule(staffMember)"
                                    class="schedule-btn">
                                  </app-button>
                                  <app-button [fontIcon]="'remove'" [color]="'warn'"
                                    (btnClick)="removeAssignment(staffMember.id, doctor.id)" class="remove-btn">
                                  </app-button>
                                </div>
                              </div>
                            }
                            @if (getStaffCountForDoctor(doctor.id) === 0) {
                              <div class="empty-assignments">
                                <app-icon [fontIcon]="'group_off'" [size]="32"></app-icon>
                                <div class="empty-text">No staff assigned</div>
                                <app-button [text]="'Assign First Staff'" [color]="'primary'" [fontIcon]="'person_add'"
                                  (btnClick)="openAssignmentDialog(doctor)" class="first-assign-btn">
                                </app-button>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>

                    <!-- Unassigned Staff Panel -->
                    @if (unassignedStaff.length > 0) {
                      <div class="unassigned-panel">
                        <div class="unassigned-header">
                          <h3>Unassigned Staff ({{ unassignedStaff.length }})</h3>
                          <app-button [text]="'Assign All'" [color]="'primary'" [fontIcon]="'group_add'"
                            (btnClick)="assignAllUnassigned()" class="assign-all-btn">
                          </app-button>
                        </div>
                        <div class="unassigned-list">
                          @for (staffMember of unassignedStaff; track staffMember) {
                            <div class="unassigned-staff-item">
                              <div class="staff-info">
                                <div class="staff-avatar-small">
                                  <app-icon [fontIcon]="'person'" [size]="16"></app-icon>
                                </div>
                                <div class="staff-details">
                                  <div class="staff-name">{{ staffMember.fullName }}</div>
                                  <div class="staff-role">{{ staffMember.role }}</div>
                                </div>
                              </div>
                              <app-selectbox [label]="'Assign to Doctor'" [options]="doctorOptions" [valueField]="'value'"
                                [displayExpr]="'label'" (dataChange)="quickAssignStaff(staffMember.id, $event)"
                                class="quick-assign-select">
                              </app-selectbox>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                </div>

              </app-tab>


            </app-tabs>
          </div>



        </app-page>