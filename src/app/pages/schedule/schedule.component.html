<app-page>
  <div class="schedule-page schedule-container" page-body>

    <!-- Section Switcher: Schedule | Timings -->
    <nav class="section-tabs" role="tablist" aria-label="Schedule sections">
      <app-button
        type="button"
        class="section-tab"
        [class.active]="activeSection === 'schedule'"
        [fontIcon]="'schedule'"
        [text]="'Schedule'"
        (btnClick)="setSection('schedule')">
      </app-button>
      <app-button
        type="button"
        class="section-tab"
        [class.active]="activeSection === 'timings'"
        [fontIcon]="'access_time'"
        [text]="'Timings'"
        (btnClick)="setSection('timings')">
      </app-button>
    </nav>

  @if (activeSection === 'schedule') {
    <section class="schedule-section" aria-label="Appointments">
      <!-- Legend + New Appointment -->
      <app-card class="sched-header-card" [dense]="true">
        <div class="sched-legend-row">
          <div class="legend-inline" aria-label="Slot status">
            <span class="legend-item"><span class="legend-dot legend-dot--available"></span>Available</span>
            <span class="legend-item"><span class="legend-dot legend-dot--booked"></span>Booked</span>
            <span class="legend-item"><span class="legend-dot legend-dot--break"></span>Break</span>
            <span class="legend-item"><span class="legend-dot legend-dot--blocked"></span>Blocked</span>
          </div>
          <app-button appearance="raised" (btnClick)="createAppointment()">
            <app-icon fontIcon="add" [size]="16"></app-icon>
            New Appointment
          </app-button>
        </div>
      </app-card>

      <!-- Select day (core app-card) -->
      <app-card class="sched-days-card" [dense]="true" [divider]="true" title="Select day" [subtitle]="'Next ' + scheduleWindowDays + ' days'">
        <div class="day-strip" role="list" aria-label="Select day for appointments">
          @for (d of scheduleWeekStrip; track d.date.getTime()) {
            <button
              type="button"
              class="day-cell"
              [class.day-cell--active]="d.isSelected"
              [class.day-cell--today]="isToday(d.date)"
              (click)="selectScheduleDate(d.date)">
              <span class="day-cell-weekday">{{ isToday(d.date) ? 'Today' : d.weekdayShort }}</span>
              <span class="day-cell-date">{{ d.monthShort }} {{ d.dayNumber }}</span>
            </button>
          }
        </div>
      </app-card>

      <!-- Appointments list (core app-card + app-divider) -->
      <app-card class="sched-list-card" [divider]="true" title="Appointments" [subtitle]="(selectedDate | date:'EEEE, MMM d, y') ?? ''" [dense]="false">
        <div appCardActions class="sched-list-meta">
          <span class="sched-count">{{ getScheduleListAppointments().length }} appointment(s)</span>
        </div>
        <div class="sched-list-body">
          <!-- Day overview: Total · Booked · Available · Break + Available slots (all in one place) -->
          <div class="appointments-day-overview">
            <div class="day-overview-stats">
              <div class="day-overview-stat">
                <span class="day-overview-label">Total Slots</span>
                <span class="day-overview-value">{{ scheduleSummary.totalSlots }}</span>
              </div>
              <div class="day-overview-stat">
                <span class="day-overview-label">Booked</span>
                <span class="day-overview-value">{{ scheduleSummary.booked < 10 ? ('0' + scheduleSummary.booked) : scheduleSummary.booked }}</span>
              </div>
              <div class="day-overview-stat">
                <span class="day-overview-label">Available</span>
                <span class="day-overview-value">{{ scheduleSummary.available < 10 ? ('0' + scheduleSummary.available) : scheduleSummary.available }}</span>
              </div>
              <div class="day-overview-stat">
                <span class="day-overview-label">Break</span>
                <span class="day-overview-value">{{ scheduleSummary.break < 10 ? ('0' + scheduleSummary.break) : scheduleSummary.break }}</span>
              </div>
            </div>
            @if (!isSlotBasedScheduling()) {
            <div class="sched-availability">
              <div class="avail-left">
                <div class="avail-title">Daily capacity</div>
                <div class="avail-sub">
                  {{ scheduleAvailability.remainingToday ?? 0 }} remaining
                  <span class="dot-sep">•</span>
                  {{ (scheduleAvailability.bookedToday ?? 0) }}/{{ (scheduleAvailability.maxPerDay ?? 0) }} booked
                </div>
              </div>
              <div class="avail-right">
                <span class="cap-pill">{{ scheduleAvailability.remainingToday ?? 0 }} slots left</span>
                <app-button
                  type="button"
                  class="cap-add-btn"
                  [text]="'Add patient'"
                  
                  [disabled]="(scheduleAvailability.remainingToday ?? 0) <= 0"
                  (btnClick)="openNextAvailableSlot()">
                </app-button>
              </div>
            </div>
          }
          </div>
          @if (getScheduleListAppointments().length > 0) {
            @for (appointment of getScheduleListAppointments(); track appointment) {
              <div
                class="apt-row"
                role="button"
                tabindex="0"
                (click)="viewAppointment(appointment)"
                (keydown.enter)="viewAppointment(appointment)"
                (keydown.space)="$event.preventDefault(); viewAppointment(appointment)">
                <div class="apt-left">
                  <div class="time-pill">{{ appointment.slotTime }}</div>
                </div>
                <div class="apt-mid">
                  <div class="apt-title">
                    <span class="apt-name">{{ appointment.patientName }}</span>
                    <span class="apt-doctor">{{ appointment.doctorName }}</span>
                  </div>
                  @if (appointment.notes) {
                    <div class="apt-sub">{{ appointment.notes }}</div>
                  }
                </div>
                <div class="apt-right">
                  <span class="status-pill" [style.background-color]="getStatusColor(appointment.status)">
                    <app-icon [fontIcon]="getStatusIcon(appointment.status)" [size]="16" class="st-ico"></app-icon>
                    {{ appointment.status }}
                  </span>
                  <span class="row-actions" (click)="$event.stopPropagation()">
                    <app-button type="button" [fontIcon]="'visibility'" title="View" [appearance]="'icon'" (btnClick)="viewAppointment(appointment)"></app-button>
                    <app-button type="button" [fontIcon]="'edit'" title="Edit" [appearance]="'icon'" (btnClick)="editAppointment(appointment)"></app-button>
                    <app-button type="button" [fontIcon]="'delete'" title="Delete" [appearance]="'icon'" (btnClick)="deleteAppointment(appointment)"></app-button>
                  </span>
                </div>
              </div>
            }
          } @else {
            <div class="sched-empty">
              <div class="empty-ico" aria-hidden="true"><app-icon fontIcon="event_available" [size]="48"></app-icon></div>
              <p class="empty-title">No appointments this day</p>
              <p class="empty-sub">Select another date, search by patient name, or create a new appointment.</p>
            </div>
          }
        </div>
      </app-card>
      <!-- Settings Dialog -->
    @if (showSettings) {
      <div class="settings-overlay" (click)="toggleSettings()">
        <div class="settings-dialog" (click)="$event.stopPropagation()">
          <div class="dialog-header">
            <h3>Schedule Settings</h3>
            <app-icon fontIcon="close" (iconClick)="toggleSettings()"></app-icon>
          </div>
          <div class="dialog-content">
            <div class="setting-group">
              <h4>General Settings</h4>
              <div class="setting-item">
                <label>Buffer Time (minutes)</label>
                <input type="number" [(ngModel)]="scheduleSettings.bufferTime" min="0" max="60">
              </div>
              <div class="setting-item">
                <label>Max Appointments Per Day</label>
                <input type="number" [(ngModel)]="scheduleSettings.maxAppointmentsPerDay" min="1" max="100">
              </div>
            </div>
            <div class="setting-group">
              <h4>Automation</h4>
              <div class="setting-item">
                <label>Auto Confirm Appointments</label>
                <mat-slide-toggle [(ngModel)]="scheduleSettings.autoConfirmAppointments"></mat-slide-toggle>
              </div>
              <div class="setting-item">
                <label>Send Reminders</label>
                <mat-slide-toggle [(ngModel)]="scheduleSettings.sendReminders"></mat-slide-toggle>
              </div>
            </div>
          </div>
          <div class="dialog-footer">
            <app-button appearance="basic" (btnClick)="toggleSettings()">Cancel</app-button>
            <app-button appearance="raised" (btnClick)="updateScheduleSettings()">Save Settings</app-button>
          </div>
        </div>
      </div>
    }
    </section>
  } @else {
    <section class="timings-section" aria-label="Doctor timings and availability">
    <div class="timings-shell">
      <div class="timings-grid">
        <div class="timings-card">
          <div class="card-head">
            <div class="card-title">
              <h3>Timings</h3>
              <p>Configure doctor availability and preview how rules apply for the next {{ forecastDays }} days.</p>
            </div>
          </div>
          <app-divider></app-divider>
          <div class="mode-tabs" role="tablist" aria-label="Timings mode">
            <app-toggle-button
              [options]="timingsModeOptions"
              [value]="timingsMode"
              (valueChange)="setTimingsMode($event)">
            </app-toggle-button>
          </div>
          @if (timingsMode === 'view') {
            <div class="priority-tabs in-card" role="tablist" aria-label="Timing priorities">
              <app-button type="button" class="priority-tab" [class.active]="timingsTab === 'p4'" [text]="'Daily Timing P4'"  (btnClick)="setTimingsTab('p4')"></app-button>
              <app-button type="button" class="priority-tab" [class.active]="timingsTab === 'p3'" [text]="'Weekly Rules P3'"  (btnClick)="setTimingsTab('p3')"></app-button>
              <app-button type="button" class="priority-tab" [class.active]="timingsTab === 'p2'" [text]="'Date Override P2'"  (btnClick)="setTimingsTab('p2')"></app-button>
              <app-button type="button" class="priority-tab" [class.active]="timingsTab === 'p1'" [text]="'Leave Management P1'"  (btnClick)="setTimingsTab('p1')"></app-button>
            </div>
            <div class="timings-card-grid">
              <!-- Left: Configuration -->
              <div class="config-pane">
                <div class="pane-head">
                  <h4>Shift Configuration</h4>
                </div>
                <!-- P4: Daily -->
                @if (timingsTab === 'p4') {
                  <div class="config-body">
                    <div class="note">
                      Shift configuration is read-only. Changes can only be made by an admin through priority rules.
                    </div>
                    <div class="readonly-grid">
                      <div class="ro-field">
                        <div class="ro-label">Start Time</div>
                        <div class="ro-value">{{ timingsDaily.start }}</div>
                      </div>
                      <div class="ro-field">
                        <div class="ro-label">End Time</div>
                        <div class="ro-value">{{ timingsDaily.end }}</div>
                      </div>
                      <div class="ro-field ro-wide">
                        <div class="ro-label">Consultation Slot Duration</div>
                        <div class="ro-value">{{ timingsDaily.slotDuration }} Minutes</div>
                      </div>
                    </div>
                    <div class="subsection">
                      <div class="sub-head">
                        <h4>Scheduled Breaks</h4>
                      </div>
                      <div class="break-list">
                        @for (b of timingsBreaks; track b) {
                          <div class="break-item">
                            <div class="break-left">
                              <app-icon fontIcon="restaurant" [size]="18"></app-icon>
                              <div class="break-meta">
                                <div class="break-name">{{ b.label }}</div>
                                <div class="break-time">{{ b.start }} - {{ b.end }}</div>
                              </div>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                    <div class="overview-card">
                      <div class="overview-head">
                        <app-icon fontIcon="insights" [size]="18"></app-icon>
                        <span>Daily Overview</span>
                      </div>
                      <div class="overview-grid">
                        <div class="ov">
                          <div class="ov-value">{{ getDailyOverview().totalSlots }}</div>
                          <div class="ov-label">Total Slots</div>
                        </div>
                        <div class="ov">
                          <div class="ov-value">{{ getDailyOverview().first }}</div>
                          <div class="ov-label">First Appt</div>
                        </div>
                        <div class="ov">
                          <div class="ov-value">{{ getDailyOverview().last }}</div>
                          <div class="ov-label">Last Appt</div>
                        </div>
                      </div>
                    </div>
                  </div>
                }
                <!-- P3: Weekly Rules -->
                @if (timingsTab === 'p3') {
                  <div class="config-body">
                    <div class="note">
                      Weekly rules apply on the same weekday every week. This section is view-only (no changes allowed).
                    </div>
                    @if (getWeeklyDaysWithRules().length > 0) {
                      <div class="selector-grid">
                        <ul class="selector-list">
                          @for (day of getWeeklyDaysWithRules(); track day) {
                            <li class="selector-li">
                              <app-button
                                type="button"
                                class="selector-item"
                                [class.active]="day === selectedWeeklyDay"
                                [text]="day + ' ' + (timingsWeeklyRules[day]?.start || '') + ' - ' + (timingsWeeklyRules[day]?.end || '') + ' (' + (timingsWeeklyRules[day]?.breaks?.length || 0) + ' breaks)'"
                                
                                (btnClick)="selectWeeklyDay(day)">
                              </app-button>
                            </li>
                          }
                        </ul>
                        @if (getSelectedWeeklyRule(); as sr) {
                          <div class="selector-detail">
                            <div class="detail-head">
                              <span class="weekday-pill">{{ selectedWeeklyDay }}</span>
                              <span class="muted">Weekly schedule</span>
                            </div>
                            <div class="readonly-grid">
                              <div class="ro-field">
                                <div class="ro-label">Start Time</div>
                                <div class="ro-value">{{ sr.start }}</div>
                              </div>
                              <div class="ro-field">
                                <div class="ro-label">End Time</div>
                                <div class="ro-value">{{ sr.end }}</div>
                              </div>
                              <div class="ro-field ro-wide">
                                <div class="ro-label">Breaks</div>
                                <div class="ro-value">{{ sr.breaks.length }}</div>
                              </div>
                            </div>
                            @if (sr.breaks.length > 0) {
                              <div class="break-chips">
                                @for (b of sr.breaks; track b) {
                                  <span class="break-chip">{{ b.label }} · {{ b.start }}-{{ b.end }}</span>
                                }
                              </div>
                            } @else {
                              <div class="empty-line">No breaks configured.</div>
                            }
                            @if (getWeeklyOverview(selectedWeeklyDay); as wov) {
                              <div class="overview-card compact">
                                <div class="overview-head">
                                  <app-icon fontIcon="insights" [size]="18"></app-icon>
                                  <span>Weekly Overview</span>
                                </div>
                                <div class="overview-grid">
                                  <div class="ov">
                                    <div class="ov-value">{{ wov.totalSlots }}</div>
                                    <div class="ov-label">Total Slots</div>
                                  </div>
                                  <div class="ov">
                                    <div class="ov-value">{{ wov.first }}</div>
                                    <div class="ov-label">First Appt</div>
                                  </div>
                                  <div class="ov">
                                    <div class="ov-value">{{ wov.last }}</div>
                                    <div class="ov-label">Last Appt</div>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="empty-line">No weekly rules configured.</div>
                    }
                  </div>
                }
                <!-- P2: Date Override -->
                @if (timingsTab === 'p2') {
                  <div class="config-body">
                    <div class="note">
                      Date overrides apply on a specific date. This section is view-only (no changes allowed).
                    </div>
                    @if (timingsOverrides.length > 0) {
                      <div class="selector-grid">
                        <ul class="selector-list">
                          @for (o of timingsOverrides; track o) {
                            <li class="selector-li">
                              <app-button
                                type="button"
                                class="selector-item"
                                [class.active]="o.date === selectedOverrideDate"
                                [text]="o.date + ' ' + o.start + ' - ' + o.end + ' (' + o.breaks.length + ' breaks)'"
                                
                                (btnClick)="selectOverrideDate(o.date)">
                              </app-button>
                            </li>
                          }
                        </ul>
                        @if (getSelectedOverride(); as so) {
                          <div class="selector-detail">
                            <div class="detail-head">
                              <span class="weekday-pill">{{ so.date }}</span>
                              <span class="muted">Date override</span>
                            </div>
                            <div class="readonly-grid">
                              <div class="ro-field">
                                <div class="ro-label">Start Time</div>
                                <div class="ro-value">{{ so.start }}</div>
                              </div>
                              <div class="ro-field">
                                <div class="ro-label">End Time</div>
                                <div class="ro-value">{{ so.end }}</div>
                              </div>
                              <div class="ro-field ro-wide">
                                <div class="ro-label">Breaks</div>
                                <div class="ro-value">{{ so.breaks.length }}</div>
                              </div>
                            </div>
                            @if (so.breaks.length > 0) {
                              <div class="break-chips">
                                @for (b of so.breaks; track b) {
                                  <span class="break-chip">{{ b.label }} · {{ b.start }}-{{ b.end }}</span>
                                }
                              </div>
                            } @else {
                              <div class="empty-line">No breaks configured.</div>
                            }
                            @if (getOverrideOverview(so); as dov) {
                              <div class="overview-card compact">
                                <div class="overview-head">
                                  <app-icon fontIcon="insights" [size]="18"></app-icon>
                                  <span>Date Overview</span>
                                </div>
                                <div class="overview-grid">
                                  <div class="ov">
                                    <div class="ov-value">{{ dov.totalSlots }}</div>
                                    <div class="ov-label">Total Slots</div>
                                  </div>
                                  <div class="ov">
                                    <div class="ov-value">{{ dov.first }}</div>
                                    <div class="ov-label">First Appt</div>
                                  </div>
                                  <div class="ov">
                                    <div class="ov-value">{{ dov.last }}</div>
                                    <div class="ov-label">Last Appt</div>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        } @else {
                          <div class="selector-detail">
                            <div class="empty-line">Select a date to view details.</div>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="empty-line">No date overrides added yet.</div>
                    }
                  </div>
                }
                <!-- P1: Leave Management -->
                @if (timingsTab === 'p1') {
                  <div class="config-body">
                    <div class="note">
                      Leave blocks availability for a specific date (highest priority). This section is view-only (no changes allowed).
                    </div>
                    @if (timingsLeaveDates.length > 0) {
                      <div class="leave-list">
                        @for (d of timingsLeaveDates; track d) {
                          <div class="leave-item">
                            <div class="leave-left">
                              <span class="weekday-pill">{{ d }}</span>
                              <span class="muted">Full day leave</span>
                            </div>
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="empty-line">No leave dates added yet.</div>
                    }
                  </div>
                }
              </div>
              <!-- Right: Forecast -->
              <div class="forecast-pane">
                <div class="pane-head">
                  <h4>Applied in next {{ forecastDays }} days</h4>
                  <span class="pane-sub">{{ getSelectedPriorityAppliedText() }}</span>
                </div>
                <div class="forecast-list forecast-scroll">
                  @for (f of filteredTimingsForecast; track f) {
                    <div class="forecast-item">
                      <div class="date-badge">
                        <div class="m">{{ getForecastDateParts(f.date).month }}</div>
                        <div class="d">{{ getForecastDateParts(f.date).day }}</div>
                      </div>
                      <div class="forecast-mid">
                        <div class="weekday">{{ getForecastDateParts(f.date).weekday }}</div>
                      </div>
                      <span class="rule-pill" [class.p4]="f.priority==='p4'" [class.p3]="f.priority==='p3'" [class.p2]="f.priority==='p2'" [class.p1]="f.priority==='p1'">
                        {{ f.label }}
                      </span>
                    </div>
                  }
                </div>
              </div>
            </div>
          } @else {
            <div class="manage-shell">
              <app-card class="manage-card logic-card" [dense]="true" title="Priority logic" subtitle="Higher priority overrides lower priority">
                <div class="logic-items">
                  <div class="logic-item p1"><span class="dot"></span><span>P1: Leave</span></div>
                  <div class="chev">›</div>
                  <div class="logic-item p2"><span class="dot"></span><span>P2: Specific Day</span></div>
                  <div class="chev">›</div>
                  <div class="logic-item p3"><span class="dot"></span><span>P3: Weekly Routine</span></div>
                  <div class="chev">›</div>
                  <div class="logic-item p4"><span class="dot"></span><span>P4: Daily (Base)</span></div>
                </div>
              </app-card>
              <!-- P1 -->
              <app-card class="manage-card prio-card p1" [dense]="true" [divider]="true" title="Leave &amp; Absences" subtitle="Priority 1 (highest)">
                <div appCardActions class="prio-actions">
                  <span class="count">{{ manageLeaves.length }} item(s)</span>
                  <app-button type="button" class="add-btn" [fontIcon]="'add'" [text]="'Add'"  (btnClick)="addManageItem('p1')"></app-button>
                </div>
                <div class="manage-list">
                  @for (item of manageLeaves; track item; let i = $index) {
                    <div class="manage-item">
                      <div class="item-main">
                        <div class="item-ico p1" aria-hidden="true">
                          <app-icon fontIcon="event_busy" [size]="20"></app-icon>
                        </div>
                        <div class="left">
                          <div class="title-row">
                            <div class="title">{{ item.label }}</div>
                            <span class="meta-chip p1">{{ item.durationLabel }}</span>
                          </div>
                          <div class="sub">
                            <app-icon fontIcon="calendar_month" [size]="18" class="mini-ico"></app-icon>
                            <span class="range">{{ item.rangeLabel }}</span>
                          </div>
                        </div>
                      </div>
                      <div class="actions">
                        <app-button type="button" [fontIcon]="'edit'" title="Edit" [appearance]="'icon'"></app-button>
                        <app-button type="button" [fontIcon]="'delete'" title="Delete" [appearance]="'icon'" (btnClick)="deleteManageItem('p1', i)"></app-button>
                      </div>
                    </div>
                  }
                </div>
              </app-card>
              <!-- P2 -->
              <app-card class="manage-card prio-card p2" [dense]="true" [divider]="true" title="Specific Day Overrides" subtitle="Priority 2 (date-specific)">
                <div appCardActions class="prio-actions">
                  <span class="count">{{ manageSpecificDays.length }} item(s)</span>
                  <app-button type="button" class="add-btn" [fontIcon]="'add'" [text]="'Add'"  (btnClick)="addManageItem('p2')"></app-button>
                </div>
                <div class="manage-list">
                  @for (item of manageSpecificDays; track item; let i = $index) {
                    <div class="manage-item">
                      <div class="item-main">
                        <div class="item-ico p2" aria-hidden="true">
                          <app-icon fontIcon="event" [size]="20"></app-icon>
                        </div>
                        <div class="left">
                          <div class="title-row">
                            <div class="title">{{ item.label }}</div>
                            <span class="meta-chip p2">{{ item.dateLabel }}</span>
                          </div>
                          <div class="sub">
                            <app-icon fontIcon="calendar_month" [size]="18" class="mini-ico"></app-icon>
                            <span class="range">{{ item.rangeLabel }}</span>
                          </div>
                        </div>
                      </div>
                      <div class="actions">
                        <app-button type="button" [fontIcon]="'edit'" title="Edit" [appearance]="'icon'"></app-button>
                        <app-button type="button" [fontIcon]="'delete'" title="Delete" [appearance]="'icon'" (btnClick)="deleteManageItem('p2', i)"></app-button>
                      </div>
                    </div>
                  }
                </div>
              </app-card>
              <!-- P3 -->
              <app-card class="manage-card prio-card p3" [dense]="true" [divider]="true" title="Weekly Routine" subtitle="Priority 3 (recurring)">
                <div appCardActions class="prio-actions">
                  <span class="count">{{ manageWeeklyRoutines.length }} item(s)</span>
                  <app-button type="button" class="add-btn" [fontIcon]="'add'" [text]="'Add'"  (btnClick)="addManageItem('p3')"></app-button>
                </div>
                <div class="manage-list">
                  @for (item of manageWeeklyRoutines; track item; let i = $index) {
                    <div class="manage-item">
                      <div class="item-main">
                        <div class="item-ico p3" aria-hidden="true">
                          <app-icon fontIcon="calendar_view_week" [size]="20"></app-icon>
                        </div>
                        <div class="left">
                          <div class="title-row">
                            <div class="title">{{ item.label }}</div>
                            <span class="meta-chip neutral">{{ item.timeLabel }}</span>
                          </div>
                          @if (item.partiallyOverridden) {
                            <div class="subtag">
                              <app-icon fontIcon="sync_problem" [size]="16" class="warn-ico"></app-icon>
                              <span>Partially Overridden</span>
                            </div>
                          }
                          <div class="sub">
                            <app-icon fontIcon="date_range" [size]="18" class="mini-ico"></app-icon>
                            <div class="day-chips">
                              @for (d of item.days; track d) {
                                <span class="chip">{{ getWeekdayAbbr(d) }}</span>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="actions">
                        <app-button type="button" [fontIcon]="'edit'" title="Edit" [appearance]="'icon'"></app-button>
                        <app-button type="button" [fontIcon]="'delete'" title="Delete" [appearance]="'icon'" (btnClick)="deleteManageItem('p3', i)"></app-button>
                      </div>
                    </div>
                  }
                </div>
              </app-card>
              <!-- P4 -->
              <app-card class="manage-card prio-card p4" [dense]="true" [divider]="true" title="Daily Base Availability" subtitle="Priority 4 (default)">
                <div appCardActions class="prio-actions">
                  <span class="singleton">Singleton</span>
                  <span class="count">{{ manageBaseAvailability.length }} item(s)</span>
                  <app-button type="button" class="add-btn" [fontIcon]="'add'" [text]="'Add'"  (btnClick)="addManageItem('p4')"></app-button>
                </div>
                <div class="manage-list">
                  @for (item of manageBaseAvailability; track item; let i = $index) {
                    <div class="manage-item">
                      <div class="item-main">
                        <div class="item-ico p4" aria-hidden="true">
                          <app-icon fontIcon="event_available" [size]="20"></app-icon>
                        </div>
                        <div class="left">
                          <div class="title-row">
                            <div class="title">{{ item.label }}</div>
                            <span class="meta-chip p4">{{ item.timeLabel }}</span>
                          </div>
                          @if (item.note) {
                            <div class="sub">
                              <app-icon fontIcon="info" [size]="18" class="mini-ico"></app-icon>
                              <span class="range">{{ item.note }}</span>
                            </div>
                          }
                        </div>
                      </div>
                      <div class="actions">
                        <app-button type="button" [fontIcon]="'edit'" title="Edit" [appearance]="'icon'"></app-button>
                        <app-button type="button" [fontIcon]="'delete'" title="Delete" [appearance]="'icon'" (btnClick)="deleteManageItem('p4', i)"></app-button>
                      </div>
                    </div>
                  }
                </div>
              </app-card>
            </div>
          }
        </div>
        <!-- This Week Schedule (view-only) -->
        @if (timingsMode === 'view') {
          <div class="week-schedule-card">
            <div class="week-head">
              <h3>This Week Schedule</h3>
              <app-button type="button" class="week-add-btn" [text]="'+ Add New Schedule'"  [disabled]="true"></app-button>
            </div>
            <div class="week-row" aria-label="This week schedule">
              @for (d of thisWeekScheduleCards; track d) {
                <div class="week-day" [class.empty]="!d.hasSchedule">
                  <div class="day-top">
                    <div class="day-top-left">
                      <div class="day-title">{{ d.weekday }}</div>
                      <div class="day-sub" [class.is-today]="d.isToday">{{ d.dateLabel }}</div>
                    </div>
                    @if (d.hasSchedule) {
                      <span class="day-pill">Fixed</span>
                    }
                  </div>
                  <div class="day-divider"></div>
                  @if (d.hasSchedule) {
                    <div class="day-body">
                      <div class="info-row">
                        <app-icon fontIcon="schedule" [size]="22"></app-icon>
                        <span class="info-text strong">{{ d.start }} - {{ d.end }}</span>
                      </div>
                      <div class="info-row">
                        <app-icon fontIcon="calendar_month" [size]="22"></app-icon>
                        <span class="info-text muted">{{ d.patternLabel }}</span>
                      </div>
                      <div class="day-table">
                        <div class="tr">
                          <div class="k">Duration</div>
                          <div class="v">{{ d.durationMin }} min</div>
                        </div>
                        <div class="tr">
                          <div class="k">Slot</div>
                          <div class="v">{{ d.totalSlots }} Total</div>
                        </div>
                      </div>
                    </div>
                    <app-button type="button" class="day-footer-btn" [text]="'Edit Details'"  [disabled]="true"></app-button>
                  } @else {
                    <div class="day-empty-body">
                      <div class="plus-circle"><span class="plus">+</span></div>
                      <div class="empty-text">Add Availability</div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
    </section>
  }

  </div>
</app-page>
