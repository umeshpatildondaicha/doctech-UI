<div class="patient-billing-dashboard" [class.embedded]="embedded">
  <!-- Header -->
  @if (!embedded) {
    <div class="dashboard-header">
      <div class="header-left">
        <app-button
        [fontIcon]="'arrow_back'"
        title="Back to Billing"
        (btnClick)="navigateBack()"
        [color]="'primary'">
      </app-button>
        <!-- <button mat-icon-button (click)="navigateBack()" matTooltip="Back to Billing">
          <mat-icon>arrow_back</mat-icon>
        </button> -->
        <div class="patient-info">
          <h2>{{ patientName || 'Patient Billing' }}</h2>
          @if (patientId) {
            <span class="patient-id">ID: {{ patientId }}</span>
          }
        </div>
      </div>
      <app-button
      [fontIcon]="'open_in_new'"
      title="Open Patient Profile"
      (btnClick)="openPatientProfileForBilling()"
      [color]="'primary'">
    </app-button>
      
    </div>
  }

  <!-- Compact header for embedded mode -->
  @if (embedded) {
    <div class="dashboard-header-compact">
      <div class="header-actions-left">
        <app-button
        [fontIcon]="'description'"
        title="statement"
        (btnClick)="generateStatement()"
        [disabled]="invoices.length === 0"
        ></app-button>
        <!-- <button mat-stroked-button (click)="generateStatement()" [disabled]="invoices.length === 0">
          <mat-icon>description</mat-icon>
          Statement
        </button> -->
      </div>
      <app-button
      [fontIcon]="'add'"
      title="New Invoice"
      (btnClick)="createNewInvoice()"
      [color]="'primary'">
    </app-button>
      
    </div>
  }

  <!-- Summary Cards -->
  <div class="summary-cards">
    <app-card class="summary-card" [dense]="true">
      <div class="card-label">Total Billed</div>
      <div class="card-value">{{ currencyFmt(summary.totalBilled) }}</div>
      <div class="card-meta">{{ summary.invoicesCount }} invoice(s)</div>
    </app-card>

    <app-card class="summary-card" [dense]="true">
      <div class="card-label">Total Paid</div>
      <div class="card-value paid">{{ currencyFmt(summary.totalPaid) }}</div>
      <div class="card-progress">
        <mat-progress-bar
          mode="determinate"
          [value]="getPaymentProgress()"
          color="primary">
        </mat-progress-bar>
        <span class="progress-text">{{ getPaymentProgress().toFixed(0) }}%</span>
      </div>
    </app-card>

    <app-card class="summary-card" [dense]="true">
      <div class="card-label">Outstanding</div>
      <div class="card-value outstanding">{{ currencyFmt(summary.totalOutstanding) }}</div>
    </app-card>

    <app-card class="summary-card" [dense]="true">
      <div class="card-label">Overdue</div>
      <div class="card-value overdue">{{ currencyFmt(summary.overdue) }}</div>
    </app-card>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    @if (!embedded) {
      <app-button
       [fontIcon]="'open_in_new'"
       [text]="'Create Invoice (via Profile)'"
       [color]="'primary'"
       (btnClick)="openPatientProfileForBilling()">
</app-button>

    }
    <app-button
    [fontIcon]="'payments'"
    [text]="'Record Payment'"
    title="Record payment for highest balance invoice"
    [disabled]="!getTopOutstandingInvoice()"
    (btnClick)="recordPayment(getTopOutstandingInvoice()!)">
  </app-button>
  
    <span class="spacer"></span>
    <div class="filter-chips">
      <app-button
      class="chip"
      [text]="'All'"
      [class.active]="activeStatus === 'ALL'"
      
      (btnClick)="applyStatusFilter('ALL')">
    </app-button>
    
    <app-button
      class="chip"
      [text]="'Unpaid'"
      [class.active]="activeStatus === 'UNPAID'"
      
      (btnClick)="applyStatusFilter('UNPAID')">
    </app-button>
    
    <app-button
      class="chip"
      [text]="'Partially Paid'"
      [class.active]="activeStatus === 'PARTIALLY_PAID'"
      [appearance]="'stroked'"
      (btnClick)="applyStatusFilter('PARTIALLY_PAID')">
    </app-button>
    
    <app-button
      class="chip"
      [text]="'Paid'"
      [class.active]="activeStatus === 'PAID'"
      
      (btnClick)="applyStatusFilter('PAID')">
    </app-button>
    
    <app-button
      class="chip"
      [text]="'Overdue'"
      [class.active]="activeStatus === 'OVERDUE'"
      
      (btnClick)="applyStatusFilter('OVERDUE')">
    </app-button>
    
    </div>
  </div>

  <!-- Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="billing-tabs">
    <!-- Invoices Tab -->
    <mat-tab label="Invoices">
      <div class="tab-content">
        <div class="invoices-section">
          @if (visibleInvoices.length > 0) {
            <app-grid
              [rowData]="visibleInvoices"
              [columnDefs]="columnDefs"
              [gridOptions]="gridOptions"
              [showAddButton]="false"
              [searchPlaceholder]="'Search invoices...'"
              [height]="embedded ? 'calc(100vh - 560px)' : 'calc(100vh - 460px)'"
              [width]="'100%'"
              (rowClicked)="openInvoiceDetails($event)">
            </app-grid>
          }
          @if (visibleInvoices.length === 0 && !loading) {
            <app-card class="empty-state">
              <div class="empty-state-content">
                <mat-icon class="empty-icon">receipt_long</mat-icon>
                <h3>No Invoices Found</h3>
                @if (activeStatus === 'ALL') {
                  <p>This patient doesn't have any invoices yet. Create the first invoice to get started.</p>
                }
                @if (activeStatus !== 'ALL') {
                  <p>No invoices match the current filter. Try changing the status filter above.</p>
                }
                @if (embedded && activeStatus === 'ALL') {
                  <app-button
                  [fontIcon]="'add'"
                  [text]="'Create First Invoice'"
                  [color]="'primary'"
                  [appearance]="'stroked'"
                  (btnClick)="createNewInvoice()"></app-button>
                  <!-- <button mat-stroked-button color="primary" (click)="createNewInvoice()">
                    <mat-icon>add</mat-icon>
                    Create First Invoice
                  </button> -->
                }
              </div>
            </app-card>
          }
        </div>
      </div>
    </mat-tab>

    <!-- Items Tab -->
    <mat-tab label="Items">
      <div class="tab-content items-tab">
        <div class="items-section">
          @if (allItems.length > 0) {
            <app-grid
              [rowData]="allItems"
              [columnDefs]="itemsColumnDefs"
              [gridOptions]="itemsGridOptions"
              [showAddButton]="false"
              [searchPlaceholder]="'Search items...'"
              [height]="embedded ? 'calc(100vh - 560px)' : 'calc(100vh - 460px)'"
              [width]="'100%'">
            </app-grid>
          }
          @if (allItems.length === 0 && !loading) {
            <app-card class="empty-state">
              <div class="empty-state-content">
                <mat-icon class="empty-icon">inventory_2</mat-icon>
                <h3>No Items Found</h3>
                <p>There are no invoice items for this patient yet.</p>
                @if (embedded) {
                  <app-button
                  [fontIcon]="'add'"
                  [text]="'Create First Invoice'"
                  [color]="'primary'"
                  [appearance]="'stroked'"
                  (btnClick)="createNewInvoice()"></app-button>
                  <!-- <button mat-stroked-button color="primary" (click)="createNewInvoice()">
                    <mat-icon>add</mat-icon>
                    Create First Invoice
                  </button> -->
                }
              </div>
            </app-card>
          }
        </div>
      </div>
    </mat-tab>

    <!-- Payments Tab -->
    <mat-tab label="Payments">
      <div class="tab-content payments-tab">
        <div class="payments-section">
          @if (allPayments.length > 0) {
            <app-grid
              [rowData]="allPayments"
              [columnDefs]="paymentsColumnDefs"
              [gridOptions]="paymentsGridOptions"
              [showAddButton]="false"
              [searchPlaceholder]="'Search payments...'"
              [height]="embedded ? 'calc(100vh - 560px)' : 'calc(100vh - 460px)'"
              [width]="'100%'">
            </app-grid>
          }
          @if (allPayments.length === 0 && !loading) {
            <app-card class="empty-state">
              <div class="empty-state-content">
                <mat-icon class="empty-icon">payments</mat-icon>
                <h3>No Payments Recorded</h3>
                <p>No payment records found for this patient. Payments will appear here once recorded.</p>
                <app-button
                [fontIcon]="'add'"
                [text]="'Record First Payment'"
                [color]="'primary'"
                [appearance]="'stroked'"
                (btnClick)="getTopOutstandingInvoice()?recordPayment(getTopOutstandingInvoice()!):null"
                [disabled]="!getTopOutstandingInvoice()"></app-button>
                <!-- <button mat-stroked-button color="primary" (click)="getTopOutstandingInvoice() ? recordPayment(getTopOutstandingInvoice()!) : null" [disabled]="!getTopOutstandingInvoice()">
                  <mat-icon>add</mat-icon>
                  Record First Payment
                </button> -->
              </div>
            </app-card>
          }
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
