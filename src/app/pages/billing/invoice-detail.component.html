@if (invoice) {
  <div class="invoice-detail">

    <!-- Header Section -->
    <div class="invoice-header">
      <div class="header-left">
        <button mat-icon-button (click)="onBack()" [matTooltip]="inDialog ? 'Close' : 'Back'">
          <mat-icon>{{ inDialog ? 'close' : 'arrow_back' }}</mat-icon>
        </button>
        <div class="invoice-info">
          <h2>Invoice {{ invoice.invoiceNo }}</h2>
          <div class="patient-info">
            <span class="patient-name">{{ invoice.patientName }}</span>
            <span class="patient-id">ID: {{ invoice.patientId }}</span>
          </div>
        </div>
      </div>
      <div class="header-right">
        <button mat-icon-button (click)="downloadPdf()" matTooltip="Download PDF">
          <mat-icon>download</mat-icon>
        </button>
        <button mat-icon-button (click)="printInvoice()" matTooltip="Print Invoice">
          <mat-icon>print</mat-icon>
        </button>
        <button mat-stroked-button (click)="editInvoice()">
          <mat-icon>edit</mat-icon>
          Edit
        </button>
      </div>
    </div>

    <!-- Invoice Meta -->
    <div class="invoice-meta">
      <div class="meta-card">
        <div class="meta-item">
          <span class="label">Status</span>
          <app-billing-status-renderer [status]="invoice.status"></app-billing-status-renderer>
        </div>
        <div class="meta-item">
          <span class="label">Issued Date</span>
          <span class="value">{{ invoice.date | date:'d MMM yyyy' }}</span>
        </div>
        <div class="meta-item">
          <span class="label">Due Date</span>
          <span class="value" [class.overdue]="isOverdue()">
            {{ invoice.dueDate | date:'d MMM yyyy' }}
            @if (isOverdue()) {
              <span class="overdue-badge">{{ getDaysOverdue() }}d overdue</span>
            }
          </span>
        </div>
      </div>
    </div>

    <!-- Payment Summary -->
    <div class="payment-summary">
      <div class="payment-card">
        <div class="payment-item">
          <span class="label">Total</span>
          <span class="value total">{{ invoice.total | billingCurrency }}</span>
        </div>
        <div class="payment-item">
          <span class="label">Paid</span>
          <span class="value paid">{{ (invoice.amountPaid || 0) | billingCurrency }}</span>
        </div>
        <div class="payment-item">
          <span class="label">Balance</span>
          <span class="value balance">{{ (invoice.balanceDue || 0) | billingCurrency }}</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="getPaymentProgress()"
          color="primary"
          class="payment-progress">
        </mat-progress-bar>
      </div>
      <div class="payment-actions">
        <button mat-flat-button color="primary" (click)="recordPayment()"
                [disabled]="invoice.status === 'PAID'">
          <mat-icon>payments</mat-icon>
          Record Payment
        </button>
        <button mat-stroked-button (click)="selectedTabIndex = 0">
          <mat-icon>add</mat-icon>
          Add Item
        </button>
        <button mat-stroked-button (click)="printInvoice()">
          <mat-icon>print</mat-icon>
          Print / Share
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="invoice-tabs">

      <!-- Items Tab -->
      <mat-tab label="Items">
        <div class="tab-content items-tab">

          <!-- Item Categories (quick-filter chips) -->
          <div class="item-categories">
            <app-button class="category-chip" [fontIcon]="'medical_services'" [text]="'Consultation'"
              [appearance]="'stroked'" [color]="'primary'" (btnClick)="editInvoice()"></app-button>
            <app-button class="category-chip" [fontIcon]="'healing'" [text]="'Standard Procedure'"
              [appearance]="'stroked'" [color]="'primary'" (btnClick)="editInvoice()"></app-button>
            <app-button class="category-chip" [fontIcon]="'science'" [text]="'Lab Work'"
              [appearance]="'stroked'" [color]="'primary'" (btnClick)="editInvoice()"></app-button>
            <app-button class="category-chip" [fontIcon]="'event'" [text]="'Follow-up Visit'"
              [appearance]="'stroked'" [color]="'primary'" (btnClick)="editInvoice()"></app-button>
          </div>

          <!-- Items Table -->
          <div class="items-table">
            <table mat-table [dataSource]="invoice.items" class="items-table-content">
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let item">{{ item.description }}</td>
              </ng-container>
              <ng-container matColumnDef="qty">
                <th mat-header-cell *matHeaderCellDef>Qty</th>
                <td mat-cell *matCellDef="let item">{{ item.quantity }}</td>
              </ng-container>
              <ng-container matColumnDef="rate">
                <th mat-header-cell *matHeaderCellDef>Rate</th>
                <td mat-cell *matCellDef="let item">{{ item.unitPrice | billingCurrency }}</td>
              </ng-container>
              <ng-container matColumnDef="discount">
                <th mat-header-cell *matHeaderCellDef>Discount</th>
                <td mat-cell *matCellDef="let item">{{ (item.discount || 0) | billingCurrency }}</td>
              </ng-container>
              <ng-container matColumnDef="tax">
                <th mat-header-cell *matHeaderCellDef>Tax</th>
                <td mat-cell *matCellDef="let item">{{ item.taxRate || 0 }}%</td>
              </ng-container>
              <ng-container matColumnDef="total">
                <th mat-header-cell *matHeaderCellDef>Total</th>
                <td mat-cell *matCellDef="let item">
                  <strong>{{ getItemTotal(item) | billingCurrency }}</strong>
                </td>
              </ng-container>
              <ng-container matColumnDef="paid">
                <th mat-header-cell *matHeaderCellDef>Paid</th>
                <td mat-cell *matCellDef="let item">
                  <span class="paid-amount">{{ (item.amountPaid || 0) | billingCurrency }}</span>
                  <div class="item-progress">
                    <mat-progress-bar
                      mode="determinate"
                      [value]="getItemTotal(item) > 0 ? ((item.amountPaid || 0) / getItemTotal(item) * 100) : 0"
                      color="primary">
                    </mat-progress-bar>
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="balance">
                <th mat-header-cell *matHeaderCellDef>Balance</th>
                <td mat-cell *matCellDef="let item">
                  <span [class.overdue]="getItemBalance(item) > 0">
                    {{ getItemBalance(item) | billingCurrency }}
                  </span>
                </td>
              </ng-container>
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let item; let i = index">
                  <app-button
                    [fontIcon]="'payments'"
                    [color]="'primary'"
                    title="Record Payment"
                    [disabled]="getItemBalance(item) <= 0 || invoice.status === 'PAID'"
                    (btnClick)="recordItemPayment(item)">
                  </app-button>
                  <app-button
                    [fontIcon]="'delete'"
                    [color]="'warn'"
                    title="Remove Item"
                    (btnClick)="removeItem(item, i)">
                  </app-button>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['description', 'qty', 'rate', 'discount', 'tax', 'total', 'paid', 'balance', 'actions']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['description', 'qty', 'rate', 'discount', 'tax', 'total', 'paid', 'balance', 'actions']"></tr>
            </table>
          </div>

          <!-- Inline Add Item Form -->
          <div class="add-item-section" [formGroup]="addItemForm">
            <mat-form-field appearance="outline">
              <mat-label>Description</mat-label>
              <input matInput formControlName="description" placeholder="e.g., Dressing, Consultation fees" />
              @if (addItemForm.controls['description'].hasError('required') && addItemForm.controls['description'].touched) {
                <mat-error>Description is required</mat-error>
              }
            </mat-form-field>
            <mat-form-field appearance="outline" class="qty-field">
              <mat-label>Qty</mat-label>
              <input matInput type="number" formControlName="quantity" min="1" />
            </mat-form-field>
            <mat-form-field appearance="outline" class="rate-field">
              <mat-label>Rate (₹)</mat-label>
              <input matInput type="number" formControlName="unitPrice" min="0" />
            </mat-form-field>
            <app-button
              [fontIcon]="'add'"
              [color]="'primary'"
              [text]="'Add Item'"
              [appearance]="'raised'"
              title="Add Item"
              (btnClick)="addItem()">
            </app-button>
          </div>

          <!-- Totals Summary -->
          <div class="totals-summary">
            <div class="total-row">
              <span>Subtotal:</span>
              <strong>{{ invoice.subTotal | billingCurrency }}</strong>
            </div>
            @if (invoice.discountTotal > 0) {
              <div class="total-row">
                <span>Discount:</span>
                <strong>{{ invoice.discountTotal | billingCurrency }}</strong>
              </div>
            }
            <div class="total-row">
              <span>Tax:</span>
              <strong>{{ invoice.taxTotal | billingCurrency }}</strong>
            </div>
            <div class="total-row grand-total">
              <span>Total:</span>
              <strong>{{ invoice.total | billingCurrency }}</strong>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Payments Tab -->
      <mat-tab label="Payments">
        <div class="tab-content payments-tab">
          <table mat-table [dataSource]="payments" class="payments-table">
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let payment">{{ payment.date | date:'d MMM yyyy HH:mm' }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef>Amount</th>
              <td mat-cell *matCellDef="let payment">
                <strong>{{ payment.amount | billingCurrency }}</strong>
              </td>
            </ng-container>
            <ng-container matColumnDef="method">
              <th mat-header-cell *matHeaderCellDef>Method</th>
              <td mat-cell *matCellDef="let payment">
                <mat-chip>{{ payment.method }}</mat-chip>
              </td>
            </ng-container>
            <ng-container matColumnDef="reference">
              <th mat-header-cell *matHeaderCellDef>Reference</th>
              <td mat-cell *matCellDef="let payment">{{ payment.reference || '-' }}</td>
            </ng-container>
            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td mat-cell *matCellDef="let payment">{{ payment.notes || '-' }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedPaymentColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedPaymentColumns"></tr>
          </table>
          @if (payments.length === 0) {
            <div class="no-payments">
              <mat-icon>receipt_long</mat-icon>
              <p>No payments recorded yet</p>
              @if (invoice.status !== 'PAID') {
                <button mat-stroked-button color="primary" (click)="recordPayment()">
                  <mat-icon>add</mat-icon>
                  Record Payment
                </button>
              }
            </div>
          }
        </div>
      </mat-tab>

      <!-- Summary Tab -->
      <mat-tab label="Summary">
        <div class="tab-content summary-tab">
          <mat-card class="summary-card">
            <h3>Invoice Summary</h3>
            <div class="summary-row">
              <span>Subtotal:</span>
              <strong>{{ invoice.subTotal | billingCurrency }}</strong>
            </div>
            <div class="summary-row">
              <span>Discount:</span>
              <strong>{{ invoice.discountTotal | billingCurrency }}</strong>
            </div>
            <div class="summary-row">
              <span>Tax:</span>
              <strong>{{ invoice.taxTotal | billingCurrency }}</strong>
            </div>
            <div class="summary-row grand-total">
              <span>Total:</span>
              <strong>{{ invoice.total | billingCurrency }}</strong>
            </div>
          </mat-card>
          <mat-card class="summary-card">
            <h3>Patient Information</h3>
            <div class="info-row">
              <span>Name:</span>
              <span>{{ invoice.patientName }}</span>
            </div>
            <div class="info-row">
              <span>Patient ID:</span>
              <span>{{ invoice.patientId }}</span>
            </div>
            @if (invoice.doctorId) {
              <div class="info-row">
                <span>Doctor ID:</span>
                <span>{{ invoice.doctorId }}</span>
              </div>
            }
          </mat-card>
          @if (invoice.notes) {
            <mat-card class="summary-card">
              <h3>Notes</h3>
              <p>{{ invoice.notes }}</p>
            </mat-card>
          }
        </div>
      </mat-tab>

      <!-- Activity Tab — real payment history -->
      <mat-tab label="Activity">
        <div class="tab-content activity-tab">
          <div class="activity-list">
            @for (payment of payments; track payment.id) {
              <div class="activity-item">
                <mat-icon class="activity-icon payment-icon">payments</mat-icon>
                <div class="activity-content">
                  <div class="activity-title">
                    Payment recorded · {{ payment.method }}
                    @if (payment.reference) {
                      <span class="activity-ref">Ref: {{ payment.reference }}</span>
                    }
                  </div>
                  <div class="activity-time">{{ payment.date | date:'d MMM yyyy, HH:mm' }}</div>
                  @if (payment.notes) {
                    <div class="activity-notes">{{ payment.notes }}</div>
                  }
                </div>
                <span class="activity-amount">{{ payment.amount | billingCurrency }}</span>
              </div>
            }
            <!-- Invoice creation is always the last event in the timeline -->
            <div class="activity-item">
              <mat-icon class="activity-icon create-icon">receipt</mat-icon>
              <div class="activity-content">
                <div class="activity-title">Invoice created</div>
                <div class="activity-time">{{ invoice.date | date:'d MMM yyyy, HH:mm' }}</div>
              </div>
            </div>
            @if (payments.length === 0) {
              <div class="no-activity">
                <mat-icon>history</mat-icon>
                <p>No payment activity yet. Record a payment to see the history here.</p>
              </div>
            }
          </div>
        </div>
      </mat-tab>

      <!-- Files Tab -->
      <mat-tab label="Files">
        <div class="tab-content files-tab">
          <div class="no-files">
            <mat-icon>folder_open</mat-icon>
            <p>No files attached</p>
            <app-button
              [fontIcon]="'upload'"
              [text]="'Upload File'"
              [appearance]="'stroked'"
              [color]="'primary'">
            </app-button>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
}
