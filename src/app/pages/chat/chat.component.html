<div class="chat-container" [class.conversation-active]="currentSession && !showPatientList">
  <!-- Left: Chats list -->
  <aside class="chat-list-panel">
    <div class="chat-list-header">
      <input type="text"
        placeholder="Search"
        [(ngModel)]="filter.searchTerm"
        (input)="onFilterChange()"
        class="search-input">
      <button type="button" class="icon-btn" title="New chat" aria-label="New chat" (click)="openPatientPicker()">
        <span class="material-icons">edit_square</span>
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="chat-tabs">
      <button type="button" class="chat-tab" [class.active]="activeChatTab === 'ALL'" (click)="setActiveTab('ALL')">All</button>
      <button type="button" class="chat-tab" [class.active]="activeChatTab === 'CURRENT'" (click)="setActiveTab('CURRENT')">Current</button>
    </div>

    <!-- Chat List -->
    @if (!isLoading) {
      <div class="chat-list">
        @for (session of filteredChatSessions; track session.id) {
          <div class="chat-list-item"
            [class.active]="currentSession?.id === session.id"
            (click)="selectChatSession(session)">
            <div class="chat-list-avatar-wrap">
              <img [src]="session.patientAvatar || getDefaultAvatar(session.patientName)"
                [alt]="session.patientName"
                class="chat-list-avatar"
                (error)="onImageError($event, session)">
              @if (session.isActive) {
                <span class="chat-online-dot"></span>
              }
            </div>
            <div class="chat-list-body">
              <div class="chat-list-row">
                <span class="chat-list-name">{{ session.patientName }}</span>
                <span class="chat-list-time">{{ formatTime(session.lastActivity) }}</span>
              </div>
              <div class="chat-list-row chat-list-preview-row">
                @if (session.lastMessage) {
                  <span class="chat-list-preview">
                    {{ session.lastMessage.senderType === 'DOCTOR' ? 'You: ' : '' }}{{ (session.lastMessage.content || '').length > 35 ? (session.lastMessage.content || '').substring(0, 35) + '...' : (session.lastMessage.content || '') }}
                  </span>
                  <span class="chat-list-checks">
                    @if (session.lastMessage.senderType === 'DOCTOR') {
                      <span class="material-icons check-icon" [class.read]="session.lastMessage.isRead">{{ session.lastMessage.isRead ? 'done_all' : 'done' }}</span>
                    }
                  </span>
                } @else {
                  <span class="chat-list-preview">No messages yet</span>
                }
              </div>
            </div>
            @if (session.unreadCount > 0) {
              <span class="chat-list-unread">{{ session.unreadCount }}</span>
            }
          </div>
        }
      </div>
    } @else {
      <div class="chat-list-loading">
        <div class="loading-spinner"></div>
        <p>Loading chats...</p>
      </div>
    }
  </aside>

  <!-- Right Panel: Conversation -->
  <main class="conversation-panel">
    @if (currentSession) {
      <!-- Conversation Header -->
      <header class="conversation-header">
        @if (isMobile) {
        <button type="button" class="conversation-back" (click)="togglePatientList()" aria-label="Back to chats">
          <span class="material-icons">arrow_back</span>
        </button>
        }
        <div class="conversation-header-info">
          <img [src]="currentSession.patientAvatar || getDefaultAvatar(currentSession.patientName)"
            [alt]="currentSession.patientName"
            class="conversation-avatar"
            (error)="onImageError($event, currentSession)">
          <div class="conversation-meta">
            <h2 class="conversation-name">{{ currentSession.patientName }}</h2>
            <p class="conversation-subtitle">
              @if (currentSession.appointmentDate) {
                Appointment {{ currentSession.appointmentDate | date:'MMM d, y' }} Â· 
              }
              {{ currentSession.appointmentStatus || 'Active' }}
            </p>
          </div>
        </div>
      </header>

      <!-- Messages (WhatsApp-style bubbles) -->
      <div class="messages-container" #messageContainer>
        @for (message of messages; track message.id) {
          <div class="message-row" [class.sent]="message.senderType === 'DOCTOR'" [class.received]="message.senderType === 'PATIENT'">
            <div class="message-bubble">
              @if (message.senderType === 'PATIENT') {
                <span class="message-sender-name">{{ message.senderName }}</span>
              }
              @if (message.messageType === 'TEXT') {
                <p class="message-text">{{ message.content }}</p>
              }
              @if (message.messageType === 'IMAGE') {
                <div class="message-image-wrap">
                  <img [src]="message.fileUrl" [alt]="message.fileName" class="message-image">
                </div>
              }
              @if (message.messageType === 'DOCUMENT' || message.messageType === 'FILE') {
                <div class="message-file">
                  <span class="material-icons">insert_drive_file</span>
                  <div>
                    <span class="message-file-name">{{ message.fileName }}</span>
                    @if (message.fileSize) {
                      <span class="message-file-size">{{ formatFileSize(message.fileSize) }}</span>
                    }
                  </div>
                  <a [href]="message.fileUrl" download class="message-download" title="Download"><span class="material-icons">download</span></a>
                </div>
              }
              <div class="message-footer">
                <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                @if (message.senderType === 'DOCTOR') {
                  <span class="material-icons message-status" [class.read]="message.isRead">{{ message.isRead ? 'done_all' : (message.isDelivered ? 'done' : 'schedule') }}</span>
                }
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Message Input (WhatsApp-style) -->
      <div class="message-input-wrap">
        <button type="button" class="input-action-btn" (click)="fileInput.click()" title="Attach">
          <span class="material-icons">add</span>
        </button>
        <div class="message-input-inner">
          <textarea
            [(ngModel)]="newMessage"
            (keydown)="onKeyPress($event)"
            placeholder="Type a message"
            class="message-input"
            rows="1"></textarea>
        </div>
        <button type="button" class="input-action-btn send-btn" [disabled]="!newMessage.trim() && selectedFiles.length === 0" (click)="sendMessage()" title="Send">
          <span class="material-icons">send</span>
        </button>
        <input #fileInput type="file" multiple (change)="onFileSelected($event)" style="display: none" accept="image/*,.pdf,.doc,.docx,.txt">
      </div>

      @if (selectedFiles.length > 0) {
        <div class="selected-files-bar">
          @for (file of selectedFiles; track file.name + file.size) {
            <div class="selected-file-chip">
              <span class="material-icons">{{ getFileIcon(file.type) }}</span>
              <span>{{ file.name }}</span>
              <button type="button" class="chip-remove" (click)="removeFile(file)"><span class="material-icons">close</span></button>
            </div>
          }
        </div>
      }
    } @else {
      <!-- No chat selected -->
      <div class="no-chat-state">
        <div class="no-chat-inner">
          <span class="material-icons no-chat-icon">chat_bubble_outline</span>
          <h3>Select a chat</h3>
          <p>Choose a patient from the list to start the conversation</p>
          @if (isMobile) {
            <button type="button" class="show-chats-btn" (click)="togglePatientList()">Open chats</button>
          }
        </div>
      </div>
    }
  </main>
</div>
