<div class="diet-dashboard">

  <!-- Tabs Section -->
  <mat-tab-group [selectedIndex]="selectedTabIndex" (selectedIndexChange)="onTabChange($event)" class="diet-tabs">
    <!-- Diets Tab -->
    <mat-tab label="Diets">
      <div class="tab-content">
        <!-- Statistics Cards (screenshot-style) -->
        <div class="stats-row">
          <div class="mini-stat">
            <div class="mini-icon bg-blue">
              <mat-icon>restaurant_menu</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Total Diets</div>
              <div class="mini-value">{{ dietList.length }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-orange">
              <mat-icon>local_fire_department</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Avg Calories</div>
              <div class="mini-value">{{ avgCalories }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-green">
              <mat-icon>fitness_center</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Avg Protein</div>
              <div class="mini-value">{{ avgProtein }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-purple">
              <mat-icon>groups</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Patients on Diets</div>
              <div class="mini-value">{{ patientsOnDiets }}</div>
            </div>
          </div>
        </div>

        <!-- Filter Bar: Search + Group Tabs + Actions -->
        <div class="filter-bar">
          <div class="filter-bar-search">
            <mat-icon class="search-icon">search</mat-icon>
            <input type="text" [(ngModel)]="searchQuery" (input)="onSearchChange($event)" placeholder="Search" class="search-input" />
          </div>
          <div class="filter-bar-tabs">
            @for (tab of getDietGroupTabs(); track tab.value) {
            <button type="button" class="filter-tab" [class.active]="selectedMealType === tab.value" (click)="selectMealTypeTab(tab.value)">
              {{ tab.label }} ({{ tab.count }})
            </button>
            }
          </div>
          <div class="filter-bar-actions">
            <app-button class="add-btn" [fontIcon]="'add'" [text]="'Add Diet'" (btnClick)="onCreateDiet()"></app-button>
            <button type="button" class="icon-btn" title="Upload" aria-label="Upload"><mat-icon>upload</mat-icon></button>
            <button type="button" class="icon-btn" title="Refresh" aria-label="Refresh" (click)="loadDietsFromApi()"><mat-icon>refresh</mat-icon></button>
            <button type="button" class="icon-btn" title="Filter" aria-label="Filter"><mat-icon>filter_list</mat-icon></button>
          </div>
        </div>

        <!-- Diet Cards Grid -->
        <div class="cards-grid">
          @for (diet of filteredDiets; track diet) {
          <app-diet-card [diet]="diet" [showActions]="true" [clickable]="true" (cardClick)="onViewDiet($event)"
            (viewClick)="onViewDiet($event)" (editClick)="onEditDiet($event)" (deleteClick)="onDeleteDiet($event)"
            (videoClick)="onVideoClick($event)" (pdfClick)="onPdfClick($event)"></app-diet-card>
          }
        </div>

        <!-- No Results -->
        @if (filteredDiets.length === 0) {
        <div class="no-results">
          <div class="no-results-card">
            <div class="no-results-content">
              <mat-icon class="no-results-icon">restaurant</mat-icon>
              <h3>No diets found</h3>
              <p>Try adjusting your search criteria or create a new diet.</p>
              <app-button class="add-btn" [fontIcon]="'add'" title="Add Diet" (btnClick)="onCreateDiet()"></app-button>
              <!-- <button mat-raised-button color="primary" (click)="onCreateDiet()">
                  <mat-icon>add</mat-icon>
                  Add Diet
                </button> -->
            </div>
          </div>
        </div>
        }
      </div>
    </mat-tab>

    <!-- Diet Plans Tab -->
    <mat-tab label="Diet Plans">
      <div class="tab-content">
        <!-- Statistics Cards for Diet Plans -->
        <div class="stats-row">
          <div class="mini-stat">
            <div class="mini-icon bg-blue">
              <mat-icon>calendar_today</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Total Plans</div>
              <div class="mini-value">{{ dietPlans.length }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-orange">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Active Plans</div>
              <div class="mini-value">{{ getActivePlansCount() }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-green">
              <mat-icon>date_range</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Weekly Plans</div>
              <div class="mini-value">{{ getWeeklyPlansCount() }}</div>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon bg-purple">
              <mat-icon>bar_chart</mat-icon>
            </div>
            <div class="mini-text">
              <div class="mini-label">Avg Adherence</div>
              <div class="mini-value">{{ getAvgAdherence() }}%</div>
            </div>
          </div>
        </div>

        <!-- Diet Plans Filter Bar: Search + Group Tabs + Actions -->
        <div class="filter-bar">
          <div class="filter-bar-search">
            <mat-icon class="search-icon">search</mat-icon>
            <input type="text" [(ngModel)]="planSearchQuery" (input)="onPlanSearchChange($event)" placeholder="Search" class="search-input" />
          </div>
          <div class="filter-bar-tabs">
            @for (tab of getPlanGroupTabs(); track tab.value) {
            <button type="button" class="filter-tab" [class.active]="selectedPlanType === tab.value" (click)="selectPlanTypeTab(tab.value)">
              {{ tab.label }} ({{ tab.count }})
            </button>
            }
          </div>
          <div class="filter-bar-actions">
            <app-button class="add-btn" [fontIcon]="'add'" [text]="'Add Plan'" title="Create Weekly Plan" (btnClick)="onCreateDietPlan()"></app-button>
            <button type="button" class="icon-btn" title="Upload" aria-label="Upload"><mat-icon>upload</mat-icon></button>
            <button type="button" class="icon-btn" title="Refresh" aria-label="Refresh" (click)="loadDietPlans()"><mat-icon>refresh</mat-icon></button>
            <button type="button" class="icon-btn" title="Filter" aria-label="Filter"><mat-icon>filter_list</mat-icon></button>
          </div>
        </div>
        <div class="diet-plans-content">
          @if (filteredDietPlans.length > 0) {
          <div class="plans-grid">
            @for (plan of filteredDietPlans; track plan) {
            <app-diet-plan-card [plan]="plan" [showActions]="true" [showFooter]="true" (cardClick)="onViewPlan($event)"
              (viewClick)="onViewPlan($event)" (editClick)="onEditPlan($event)"
              (deleteClick)="onDeletePlan($event)"></app-diet-plan-card>
            }
          </div>
          } @else {
          <div class="no-results">
            <div class="no-results-card">
              <div class="no-results-content">
                <mat-icon class="no-results-icon">calendar_today</mat-icon>
                <h3>No diet plans found</h3>
                <p>Create your first weekly diet plan to get started.</p>
                <!-- <button mat-raised-button color="primary" (click)="onCreateDietPlan()">
                      <mat-icon>add</mat-icon>
                      Create Weekly Plan
                    </button> -->
                <app-button class="add-btn" [fontIcon]="'add'" title="Create Weekly Plan"
                  (btnClick)="onCreateDietPlan()"></app-button>
              </div>
            </div>
          </div>
          }

        </div>
      </div>